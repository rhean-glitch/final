;/*FB_PKG_DELIM*/

__d("EBSMGatingUI",["EBSMGating","MAWWaitForBackendSetup"],(function(a,b,c,d,e,f,g){"use strict";function a(){return d("MAWWaitForBackendSetup").isBackendSetupSuccessful()||d("EBSMGating").isPersistedEBTableEnabled()}g.isBackendSetupSuccessfulForEBSM=a}),98);
__d("LSOnboardFromExistingDeviceStart",["LSGetLatestEpochKeys","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][onboardFromExistingDeviceStart] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.db.table(282).add({stateKey:"auto_restored",stateValue:"true"})},function(b){return c.db.table(185).add({pk:c.i64.cast([0,1]),backupId:a[0],deviceRegistrationId:a[2],taskId:c.i64.cast([0,1])})},function(a){return c.storedProcedure(b("LSGetLatestEpochKeys"),!1).then(function(a){return a=a,d[2]=a[0],d[3]=a[1],a})},function(e){return d[2]!==void 0?c.sequence([function(e){return d[11]=d[2].get("epoch_keys"),d[12]=d[11].get("epoch_id"),d[13]=new c.Map(),d[13].set("existing_device_id",a[1]),d[13].set("base_epoch_id",d[12]),d[14]=new c.Map(),d[14].set("success",d[13]),d[15]=c.toJSON(d[14]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50036]),d[15],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[4]=void 0}]):c.sequence([function(a){return d[3]!==void 0?c.sequence([function(a){return d[12]=d[3].get("error_message"),d[13]=d[3].get("error_code"),d[14]=new c.Map(),d[14].set("error_code",d[13]),d[14].set("stored_procedure","onboardFromExistingDeviceStart"),d[14].set("error_message",d[12]),d[15]=new c.Map(),d[15].set("failure",d[14]),d[16]=c.toJSON(d[15]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50036]),d[16],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[17]=a[0],a})},function(a){return d[18]=new c.Map(),d[18].set("error_code",d[13]),d[18].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure"),d[18].set("error_message",""),d[11]=d[18]}]):c.sequence([function(a){return d[12]=new c.Map(),d[12].set("error_code",c.i64.cast([0,603])),d[12].set("stored_procedure","onboardFromExistingDeviceStart"),d[12].set("error_message","Unknown error encountered"),d[13]=new c.Map(),d[13].set("failure",d[12]),d[14]=c.toJSON(d[13]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"meb_onboard_from_existing_device",c.i64.cast([0,50036]),d[14],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[15]=a[0],a})},function(a){return d[16]=new c.Map(),d[16].set("error_code",c.i64.cast([0,603])),d[16].set("stored_procedure","LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure"),d[16].set("error_message",""),d[11]=d[16]}])},function(a){return d[4]=d[11]}])},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][onboardFromExistingDeviceStart] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"onboardFromExistingDeviceStart",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[4]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsOnboardFromExistingDeviceStartStoredProcedure";a.__tables__=["experiences_shared_state","device_metadata"];e.exports=a}),null);
__d("LSOnboardFromExistingDeviceStartStoredProcedure",["LSOnboardFromExistingDeviceStart","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSOnboardFromExistingDeviceStart"),e.backupId,e.previousDeviceId,e.newDeviceRegistrationId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWEncryptedBackupsInitializeRestoreDeferred",["MWChatEncryptedBackupsQPLEvents","QPLUserFlow","WALogger","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error initializing restore: ",""]);h=function(){return a};return a}var i=c("requireDeferred")("MWEncryptedBackupsInitializeRestore").__setRef("MWEncryptedBackupsInitializeRestoreDeferred");function a(a){var b=a.db,e=a.onFailure,f=a.onSuccess;i.onReady(function(a){c("QPLUserFlow").addPoint(d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,"add_device_init_restore_sproc"),c("promiseDone")(a.initializeRestore(b),f,function(a){d("WALogger").ERROR(h(),a),e==null?void 0:e("failed_to_initialize_restore")})})}g.encryptedBackupsInitializeRestoreDeferred=a}),98);
__d("EBAddDeviceWithKeys",["ClientConsistencyEventEmitter","CurrentAppID","EBAPIQPLPoints","EBSMAPI","EBSMGatingUI","I64","LSAuthorityLevel","LSFactory","LSIntEnum","LSOnboardFromExistingDeviceStartStoredProcedure","LSShape","MAWEncryptedBackupsPersistedDB","MAWIndexedDbMetadata","MWChatEncryptedBackupsLogging","MWChatEncryptedBackupsQPLEvents","MWEBODSEntityName.enum","MWEncryptedBackupsInitializeRestoreDeferred","MWEncryptedBackupsLocalStorageEntryEnum","MWEncryptedBackupsSharedState","ODS","Promise","QPLUserFlow","ReQL","WAHashStringToNumber","WALogger","err","getErrorSafe","gkx","justknobx","promiseDone","qpl","requireDeferred","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k;function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys initialize restore success"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys initialize restore failed"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys client state row added"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithKeys sproc failed, isInWorker: ",", error: ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys caling LSOnboardFromExistingDeviceStartStoredProcedure"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI addDeviceWithEBKeys start"]);s=function(){return a};return a}var t=c("requireDeferred")("MWEBUseLocalStorage").__setRef("EBAddDeviceWithKeys");function a(a){var e=a.backupId,g=a.db,v=a.isInWorker,w=a.newDeviceRegistrationId,x=a.previousDeviceId,y=a.source,z=a.trackAddingDevice;return new(k||(k=b("Promise")))(function(a,b){d("WALogger").LOG(s());v||u("START_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC",d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent);var k=d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")()),A=c("qpl")._(521473756,"2768"),B=y;c("QPLUserFlow").start(A,{annotations:{bool:{isEBAddDeviceWithKeys:!0,isGraphQL:!1,isInWorker:v},string:{restore_type:B}},instanceKey:k,timeoutInMs:c("justknobx")._("4226")});c("QPLUserFlow").addPoint(c("qpl")._(521473756,"2768"),d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_START,{instanceKey:k});(h||(h=d("ODS"))).bumpEntityKey(7319,B,"start");d("WALogger").LOG(r());g.runInTransaction(function(a){return c("LSOnboardFromExistingDeviceStartStoredProcedure")(c("LSFactory")(a),{backupId:e,newDeviceRegistrationId:w,previousDeviceId:x})},"readwrite",void 0,void 0,f.id+":113").then(function(e){e=e[0];v||u("END_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC",d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent);c("QPLUserFlow").addPoint(c("qpl")._(521473756,"2768"),d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_END,{instanceKey:k});if(e!=null){var f=d("LSShape").toRecord(e).error_message;v||(v||u("FAIL_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC_WIPE_EBSM",d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent),v||u("FAIL_LS_ADD_DEVICE_WITH_EB_KEYS_SPROC_WIPE_EBSM",d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent),d("MWChatEncryptedBackupsLogging").endFailure({errorName:f,event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),d("MWChatEncryptedBackupsLogging").endFailure({errorName:f,event:d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}));c("QPLUserFlow").endFailure(c("qpl")._(521473756,"2768"),d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{annotations:{string:{error_code:(i||(i=d("I64"))).to_string(d("LSShape").toRecord(e).error_code),error_message:f}},instanceKey:k});(h||(h=d("ODS"))).bumpEntityKey(7319,B,"fail");d("WALogger").ERROR(q(),v.toString(),f);e=c("gkx")("11709")&&v?d("MAWIndexedDbMetadata").EBSM_WORKER_DB_PREFIX:"";c("promiseDone")(d("MAWEncryptedBackupsPersistedDB").deleteEBIDB(e));if(!v)switch(d("CurrentAppID").getAppID()){case 772021112871879..toString():c("ClientConsistencyEventEmitter").emit("hardRefresh","eb_autorestore_error");break;default:c("ClientConsistencyEventEmitter").emit("softRefresh","eb_autorestore_error")}b(c("err")(f))}c("QPLUserFlow").addPoint(c("qpl")._(521473756,"2768"),d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SUBSCRIPTION_START,{instanceKey:k});var l=d("ReQL").fromTableAscending(g.tables.secure_encrypted_backups_client_state).subscribe(function(b,e){if(e.operation==="add"||e.operation==="put"){b=e.value;e=b.authorityLevel;b=b.deviceId;(i||(i=d("I64"))).equal(e,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))&&(v||u("END_LS_ADD_DEVICE_WITH_EB_KEYS_TASK",d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent),c("QPLUserFlow").addPoint(c("qpl")._(521473756,"2768"),d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SUBSCRIPTION_END,{instanceKey:k}),l(),c("promiseDone")(d("MWEncryptedBackupsSharedState").upsertEBSharedStateEntry({db:g,stateKey:c("MWEncryptedBackupsLocalStorageEntryEnum").ENCRYPTED_BACKUPS_RESTORED_SUCCESSFULLY})),d("WALogger").LOG(p()),v||(t.onReady(function(a){var b=a.mwEBCreateLocalStorageEntry;a=a.mwEBDeleteLocalStorageEntry;b(c("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION);b(c("MWEncryptedBackupsLocalStorageEntryEnum").MW_EB_HAS_RESTORED_IN_CURRENT_SESSION_2);a(c("MWEncryptedBackupsLocalStorageEntryEnum").EBSM_CORRUPTION_WIPE)}),z(b),d("MWEncryptedBackupsInitializeRestoreDeferred").encryptedBackupsInitializeRestoreDeferred({db:g,onFailure:function(){d("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{is_backend_setup:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:"FAILED_TO_RESTORE_ENCRYPTED_BACKUP",event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),d("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{is_backend_setup:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:"FAILED_TO_RESTORE_ENCRYPTED_BACKUP",event:d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),d("WALogger").ERROR(o())},onSuccess:function(){c("QPLUserFlow").addAnnotations(d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent,{string:{restore_type:"auto_restore"}}),d("MWChatEncryptedBackupsLogging").endSuccess({annotations:{bool:{is_backend_setup:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),d("MWChatEncryptedBackupsLogging").endSuccess({event:d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}),d("WALogger").LOG(n())}})),c("EBSMAPI").fetchBackupIds(g)["catch"](function(a){d("WALogger").ERROR(m(),c("getErrorSafe")(a).message)}),c("QPLUserFlow").endSuccess(c("qpl")._(521473756,"2768"),{instanceKey:k}),(h||(h=d("ODS"))).bumpEntityKey(7319,B,"success"),a())}})})["catch"](function(a){a="[wmi][ebsm] EBAPI addDeviceWithKeys sproc error, isInWorker: "+v.toString()+", error: "+c("getErrorSafe")(a).message;v||(d("MWChatEncryptedBackupsLogging").endFailure({annotations:{bool:{is_backend_setup:d("EBSMGatingUI").isBackendSetupSuccessfulForEBSM()}},errorName:a,event:d("MWChatEncryptedBackupsQPLEvents").restoreQplEvent}),d("MWChatEncryptedBackupsLogging").endFailure({errorName:a,event:d("MWChatEncryptedBackupsQPLEvents").restoreDeviceAuthQplEvent,odsEntityName:c("MWEBODSEntityName.enum").MW_EB_AUTO_RESTORE_AUTH}));c("QPLUserFlow").endFailure(c("qpl")._(521473756,"2768"),d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{annotations:{string:{error_message:a}},instanceKey:k});(h||(h=d("ODS"))).bumpEntityKey(7319,B,"fail");d("WALogger").ERROR(l(),a);b(c("err")(a))})})}function u(a,b){c("QPLUserFlow").addPoint(b,a)}g.addDeviceWithEBKeys=a}),98);
__d("GaloisField32",["FBLogger"],(function(a,b,c,d,e,f,g){"use strict";var h=c("FBLogger")("labyrinth_web"),i=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,0,2,4,6,8,10,12,14,16,18,20,22,24,26,28,30,5,7,1,3,13,15,9,11,21,23,17,19,29,31,25,27,0,3,6,5,12,15,10,9,24,27,30,29,20,23,18,17,21,22,19,16,25,26,31,28,13,14,11,8,1,2,7,4,0,4,8,12,16,20,24,28,5,1,13,9,21,17,29,25,10,14,2,6,26,30,18,22,15,11,7,3,31,27,23,19,0,5,10,15,20,17,30,27,13,8,7,2,25,28,19,22,26,31,16,21,14,11,4,1,23,18,29,24,3,6,9,12,0,6,12,10,24,30,20,18,21,19,25,31,13,11,1,7,15,9,3,5,23,17,27,29,26,28,22,16,2,4,14,8,0,7,14,9,28,27,18,21,29,26,19,20,1,6,15,8,31,24,17,22,3,4,13,10,2,5,12,11,30,25,16,23,0,8,16,24,5,13,21,29,10,2,26,18,15,7,31,23,20,28,4,12,17,25,1,9,30,22,14,6,27,19,11,3,0,9,18,27,1,8,19,26,2,11,16,25,3,10,17,24,4,13,22,31,5,12,23,30,6,15,20,29,7,14,21,28,0,10,20,30,13,7,25,19,26,16,14,4,23,29,3,9,17,27,5,15,28,22,8,2,11,1,31,21,6,12,18,24,0,11,22,29,9,2,31,20,18,25,4,15,27,16,13,6,1,10,23,28,8,3,30,21,19,24,5,14,26,17,12,7,0,12,24,20,21,25,13,1,15,3,23,27,26,22,2,14,30,18,6,10,11,7,19,31,17,29,9,5,4,8,28,16,0,13,26,23,17,28,11,6,7,10,29,16,22,27,12,1,14,3,20,25,31,18,5,8,9,4,19,30,24,21,2,15,0,14,28,18,29,19,1,15,31,17,3,13,2,12,30,16,27,21,7,9,6,8,26,20,4,10,24,22,25,23,5,11,0,15,30,17,25,22,7,8,23,24,9,6,14,1,16,31,11,4,21,26,18,29,12,3,28,19,2,13,5,10,27,20,0,16,5,21,10,26,15,31,20,4,17,1,30,14,27,11,13,29,8,24,7,23,2,18,25,9,28,12,19,3,22,6,0,17,7,22,14,31,9,24,28,13,27,10,18,3,21,4,29,12,26,11,19,2,20,5,1,16,6,23,15,30,8,25,0,18,1,19,2,16,3,17,4,22,5,23,6,20,7,21,8,26,9,27,10,24,11,25,12,30,13,31,14,28,15,29,0,19,3,16,6,21,5,22,12,31,15,28,10,25,9,26,24,11,27,8,30,13,29,14,20,7,23,4,18,1,17,2,0,20,13,25,26,14,23,3,17,5,28,8,11,31,6,18,7,19,10,30,29,9,16,4,22,2,27,15,12,24,1,21,0,21,15,26,30,11,17,4,25,12,22,3,7,18,8,29,23,2,24,13,9,28,6,19,14,27,1,20,16,5,31,10,0,22,9,31,18,4,27,13,1,23,8,30,19,5,26,12,2,20,11,29,16,6,25,15,3,21,10,28,17,7,24,14,0,23,11,28,22,1,29,10,9,30,2,21,31,8,20,3,18,5,25,14,4,19,15,24,27,12,16,7,13,26,6,17,0,24,21,13,15,23,26,2,30,6,11,19,17,9,4,28,25,1,12,20,22,14,3,27,7,31,18,10,8,16,29,5,0,25,23,14,11,18,28,5,22,15,1,24,29,4,10,19,9,16,30,7,2,27,21,12,31,6,8,17,20,13,3,26,0,26,17,11,7,29,22,12,14,20,31,5,9,19,24,2,28,6,13,23,27,1,10,16,18,8,3,25,21,15,4,30,0,27,19,8,3,24,16,11,6,29,21,14,5,30,22,13,12,23,31,4,15,20,28,7,10,17,25,2,9,18,26,1,0,28,29,1,31,3,2,30,27,7,6,26,4,24,25,5,19,15,14,18,12,16,17,13,8,20,21,9,23,11,10,22,0,29,31,2,27,6,4,25,19,14,12,17,8,21,23,10,3,30,28,1,24,5,7,26,16,13,15,18,11,22,20,9,0,30,25,7,23,9,14,16,11,21,18,12,28,2,5,27,22,8,15,17,1,31,24,6,29,3,4,26,10,20,19,13,0,31,27,4,19,12,8,23,3,28,24,7,16,15,11,20,6,25,29,2,21,10,14,17,5,26,30,1,22,9,13,18],j=[0,1,18,28,9,23,14,12,22,4,25,16,7,15,6,13,11,24,2,29,30,26,8,5,17,10,21,31,3,19,20,27],k="ACDEFHJKLMNPQRSTUVWXYZ0123456789",l=function(){var a={};for(var b=0;b<k.length;b++)a[k[b]]=b;return a}();function m(a,b){return i[a*32+b]}function a(a){var b=[];for(var c=0;c<a.length;c++){if(!(a[c]in l)){h.mustfix("gf32: tried to convert invalid string to GF32 matrix: %s",a);return null}b[c]=l[a[c]]}return b}function b(a){var b=[];for(a of a)b.push(k[a]);return b.join("")}function n(a){return a===0||a===1||a===2||a===3||a===4||a===5||a===6||a===7||a===8||a===9||a===10||a===11||a===12||a===13||a===14||a===15||a===16||a===17||a===18||a===19||a===20||a===21||a===22||a===23||a===24||a===25||a===26||a===27||a===28||a===29||a===30||a===31?a:null}function d(a){var b=[];for(var c=0;c<a.length;c++){var d=n(a[c]);if(d==null)throw h.mustfixThrow("gf32: tried to convert bad value to GF32 element: %s",a[c]);b.push(d)}return b}function o(a,b){var c=a^b,d=n(c);if(d==null)throw h.mustfixThrow("gf32: xor of gf32 elements returned a non-element (should be impossible): %s ^ %s = %s",a,b,c);return d}function p(a,b,c,d,e){for(var f=0;f<b;f++)a[c*b+f]=o(a[c*b+f],m(a[d*b+f],e))}function q(a,b,c,d){for(var e=0;e<b;e++){var f=a[c*b+e];a[c*b+e]=a[d*b+e];a[d*b+e]=f}}function r(a,b,c,d){for(var e=0;e<b;e++)a[c*b+e]=m(a[c*b+e],d)}function s(a,b){if(b===0)throw h.mustfixThrow("gf32: tried to divide by 0");return m(a,j[b])}function t(a){var b=Array(a*a).fill(0);for(var c=0;c<a;c++)b[c*a+c]=1;return b}function e(a,b){a=a.slice();var c=t(b);for(var d=0;d<b;d++){var e=d;if(a[d*b+e]===0){var f=!1;for(var g=d+1;g<b;g++)if(a[g*b+e]!==0){q(a,b,d,g);q(c,b,d,g);f=!0;break}if(!f)return null}for(g=d+1;g<b;g++){f=s(a[g*b+e],a[d*b+e]);p(a,b,g,d,f);p(c,b,g,d,f)}}for(f=b-1;f>=0;f--){e=f;for(g=f-1;g>=0;g--){d=s(a[g*b+e],a[f*b+e]);p(a,b,g,f,d);p(c,b,g,f,d)}}for(d=0;d<b;d++){e=a[d*b+d];if(e===0)return null;r(c,b,d,j[e])}return c}f=0;g.zero=f;g.matrixToSymbols=b;g.symbolsToMatrix=a;g.invert=e;g.xor=o;g.multiply=m;g.asGf32MatExn=d}),98);
__d("GF32RecoveryCodes",["FBLogger","GaloisField32"],(function(a,b,c,d,e,f,g){"use strict";var h=c("FBLogger")("labyrinth_web"),i=34,j=4,k=3,l=i+j,m=d("GaloisField32").asGf32MatExn([18,24,16,12,8,20,2,19,4,22,21,5,28,5,14,21,7,16,15,10,3,9,28,22,11,30,19,6,7,7,9,18,16,2,9,12,18,14,7,6,5,16,9,24,16,28,19,2,14,8,2,4,1,21,26,21,10,27,16,25,18,14,20,17,11,22,21,22,16,20,2,5,0,9,6,7,23,23,23,11,6,5,3,31,29,30,17,28,0,30,28,7,13,5,11,22,12,16,25,3,20,22,26,22,14,29,5,14,5,19,12,19,18,8,25,7,30,7,8,12,0,26,15,10,17,21,2,29,14,4,31,7,29,6,29,1,14,16,17,15,4,16,7,4,7,4,8,26,10,23,24,26]);function n(a,b,c){c===void 0&&(c=1);var d=[];for(a=a;a<b;a+=c)d.push(a);return d}var o={};function p(a,b){function c(a,b,d,e){if(b<=0)return[[]];if(e-d<=b)return[n(d,e)];var f=a|b<<8|d<<16|e<<24,g=o[f];if(g!=null)return g;var h=[];c(a-1,b-1,d+1,e).forEach(function(a){a=a.slice();a.splice(0,0,d);h.push(a)});c(a-1,b,d+1,e).forEach(function(a){h.push(a.slice())});o[f]=h;return h}return c(a,b,0,a)}function q(a,b){var c=a.length,d=Array(c*c).fill(0),e=0;for(var f=0;f<j;f++){if(f===b)continue;for(var g=0;g<c;g++){var h=a[g];d[e*c+g]=m[f*l+h]}e++}return d}function r(a,b){for(var c=0;c<j;c++){var e=q(a,c);e=d("GaloisField32").invert(e,b);if(e!=null)return{excludeRow:c,submatInv:e}}return null}function a(a){var b=Array(j).fill(0);for(var c=0;c<j;c++)for(var e=0;e<i;e++)b[c]=d("GaloisField32").xor(b[c],d("GaloisField32").multiply(m[c*l+e],a[e]));e=Array(j*j);for(a=0;a<j;a++)for(c=0;c<j;c++)e[a*j+c]=m[a*l+i+c];c=d("GaloisField32").invert(e,j);if(c==null)throw h.mustfixThrow("gf32: failed to invert error code submatrix (should be impossible): %s",JSON.stringify(e));a=Array(j).fill(0);for(e=0;e<j;e++)for(var f=0;f<j;f++)a[e]=d("GaloisField32").xor(a[e],d("GaloisField32").multiply(c[e*j+f],b[f]));return a}function b(a){var b=new Set(),c=d("GaloisField32").symbolsToMatrix(a);if(c==null){h.warn("gf32: recovery code %s could not be converted to GF32 matrix",a);return[a]}a=Array(j).fill(0);for(var e=0;e<j;e++)for(var f=0;f<l;f++)a[e]=d("GaloisField32").xor(a[e],d("GaloisField32").multiply(m[e*l+f],c[f]));f=p(l,k);for(e of f){f=a.slice();for(var g=0;g<j;g++)for(var i of e)f[g]=d("GaloisField32").xor(f[g],d("GaloisField32").multiply(m[g*l+i],c[i]));i=r(e,k);if(i==null){h.warn("gf32: no submat inverse found for error locs %s",JSON.stringify(e));continue}g=i.excludeRow;i=i.submatInv;var n=Array(k).fill(0),o=f.slice();o.splice(g,1);for(var q=0;q<k;q++)for(var s=0;s<k;s++)n[q]=d("GaloisField32").xor(n[q],d("GaloisField32").multiply(i[q*k+s],o[s]));s=d("GaloisField32").zero;for(q=0;q<k;q++)s=d("GaloisField32").xor(s,d("GaloisField32").multiply(m[g*l+e[q]],n[q]));if(s===f[g]){i=c.slice();for(o=0;o<e.length;o++)i[e[o]]=n[o];b.add(d("GaloisField32").matrixToSymbols(i))}}return Array.from(b)}g.getEccForCode=a;g.getCandidateCodes=b}),98);
__d("checkLSRecoveryCodeMatch",["LSBinaryToHex.nop","LSShape","LSVec","Promise","nullthrows"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,e,f,g,i){i=c("LSVec").toArray(i).map(function(a){return d("LSShape").toRecord(a)});var j=c("LSBinaryToHex.nop")(a,e,c("nullthrows")(f)),k=function(d,i){return d.then(function(d){if(d[0]!=null)return(h||(h=b("Promise"))).resolve(d);d=c("LSBinaryToHex.nop")(a,e,i.virtual_device_id);return(h||(h=b("Promise"))).all([j,d]).then(function(a){var c=a[0],d=a[1];a=c.length===d.length&&c.every(function(a,b){return a===d[b]});if(a)return(h||(h=b("Promise"))).resolve([f,g]);else return(h||(h=b("Promise"))).resolve([void 0,void 0])})})};return i.reduce(k,(h||(h=b("Promise"))).resolve([void 0,void 0]))}g["default"]=a}),98);
__d("deriveLSKey",["I64","LSCreateDerivedKeys.nop","LSCryptoUtils","LSVec"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a,b,e,f,g){g=g==="1"?(h||(h=d("I64"))).of_string("8"):(h||(h=d("I64"))).of_string("16");g=c("LSVec").ofArray([g,(h||(h=d("I64"))).of_string("32")]);return c("LSCreateDerivedKeys.nop")(a,b,d("LSCryptoUtils").strToBuf(f),void 0,d("LSCryptoUtils").strToBuf(e),g).then(function(a){a=a[0];if(a==null)return[void 0,void 0];a=c("LSVec").toArray(a);return a.length===2?[a[0],a[1]]:[void 0,void 0]})}g["default"]=a}),98);
__d("parseLSRecoveryCode",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=a.substring(0,1);if(a.length!==40||c!=="1"&&c!=="2")return;var d=c==="1"?35:34,e=a.substring(1,2);a=a.substring(2,d+2);d="BackupRecoveryCode_v"+c+"_"+e+"_"+b;return[a,d,c]}f["default"]=a}),66);
__d("LSParseRecoveryCode_v2.nop",["CryptoLogger","GF32RecoveryCodes","Promise","checkLSRecoveryCodeMatch","deriveLSKey","parseLSRecoveryCode"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(a,e,f,g,i){var j=d("CryptoLogger").CryptoLogger("parse_recovery_code_v2");f=c("parseLSRecoveryCode")(f,g);if(f!=null)return c("deriveLSKey")(a,e,f[0],f[1],f[2]);else{i&&j.mustfix("could not parse recovery code with uid");return(h||(h=b("Promise"))).resolve([void 0,void 0])}}var j=new Map([["B","8"],["G","C"],["I","1"],["O","0"]]),k=new RegExp("["+Array.from(j.keys()).join("")+"]","g");function l(a){return a.replace(k,function(a){return j.get(a)||a})}a=function(a,e,f,g,j){if(f.length!==40)return(h||(h=b("Promise"))).resolve([void 0,void 0]);var k=f.substring(0,2),m=l(f.substring(2,40));f=d("GF32RecoveryCodes").getCandidateCodes(m);var n=function(d,f){return d.then(function(d){if(d[0]!=null)return(h||(h=b("Promise"))).resolve(d);else return i(a,e,k+f,g,!1).then(function(d){var f=d[0];if(f==null)return(h||(h=b("Promise"))).resolve([void 0,void 0]);else return c("checkLSRecoveryCodeMatch")(a,e,f,d[1],j)}).then(function(a){if(a[0]==null)return[void 0,void 0];else return a})})};return f.reduce(n,(h||(h=b("Promise"))).resolve([void 0,void 0])).then(function(c){return c[0]==null?i(a,e,k+m,g,!0):(h||(h=b("Promise"))).resolve(c)})};a.__nop_name__="LSParseRecoveryCode_v2";g["default"]=a}),98);
__d("LSAddDevice",["LSArrayGetObjectAt","LSBase64Encode.nop","LSGetViewerFBID","LSHandleWrongRecoveryCode","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop","LSParseRecoveryCode_v2.nop","justknobx"],(function(a,b,c,d,e,f,g){function a(){var a=arguments,d=a[a.length-1],e=[],f=[];return d.sequence([function(g){return d.sequence([function(f){return e[0]=d.i64.of_float(Date.now()),function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Beginning execution."),c("justknobx")._("946")?d.sequence([function(a){return e[8]=d.createArray(),d.forEach(d.db.table(179).fetch(),function(a){var b=a.item;return d.sequence([function(a){return e[15]=b.taskId,d.db.table(2).fetch([[[e[15]]]]).next().then(function(a,b){b=a.done;a=a.value;return b?e[13]=!1:(a.item,e[13]=!0)})},function(a){return e[13]?0:e[16]=(e[8].push(e[15]),e[8])}])})},function(a){return e[9]=d.i64.of_int32(e[8].length),d.i64.gt(e[9],d.i64.cast([0,0]))?d.loopAsync(e[9],function(a){return e[13]=a,d.sequence([function(a){return d.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),e[8],e[13]).then(function(a){return a=a,e[14]=a[0],e[15]=a[1],a})},function(a){return d.forEach(d.db.table(179).fetch([[[e[14]]]]),function(a){return a["delete"]()})}])}):d.resolve()},function(a){return d.db.table(179).fetch().next().then(function(a,b){b=a.done;a=a.value;return b?e[10]=!1:(a.item,e[10]=!0)})},function(c){return e[10]?d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] add device task already pending"),e[14]="add device task already pending",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ","",e[14]].join("")),e[13]=d.createArray(),void 0!==void 0?e[15]=(e[13].push(void 0),e[13]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",e[14],e[13],d.i64.cast([0,3]))},function(a){return e[12]=d.i64.cast([0,1])}]):d.sequence([function(b){return e[13]=d.createArray(),d.forEach(d.filter(d.db.table(184).fetch(),function(b){return d.i64.eq(b.backupId,a[0])}),function(a){a=a.item;return e[19]=new d.Map(),e[19].set("virtual_device_id",a.virtualDeviceId),e[20]=(e[13].push(e[19]),e[13])})},function(a){return d.db.table(172).fetch().next().then(function(a,b){var c=a.done;a=a.value;return c?e[14]=void 0:(b=a.item,e[20]=b.encryptionManagementDelegatorId,d.i64.neq(e[20],void 0)?(d.i64.neq(e[20],d.i64.cast([0,0]))?e[21]=d.i64.to_string(e[20]):e[21]=void 0,e[19]=e[21]):e[19]=void 0,e[14]=e[19])})},function(a){return d.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,e[16]=a[0],a})},function(c){return d.nativeOperation(b("LSParseRecoveryCode_v2.nop"),a[1],e[14]==null?d.i64.to_string(e[16]):e[14],e[13]).then(function(a){return a=a,e[17]=a[0],e[18]=a[1],a})},function(c){return d.blobs.neq(e[17],void 0)?d.blobs.neq(e[18],void 0)?d.sequence([function(a){return d.nativeOperation(b("LSBase64Encode.nop"),e[17]).then(function(a){return a=a,e[19]=a[0],a})},function(a){return d.db.table(178).put({pk:d.i64.cast([0,1]),recoveryCodeStatus:d.i64.cast([0,1])})},function(c){return e[24]=d.i64.cast([0,1e3]),e[20]=e[24],e[21]=new d.Map(),e[21].set("backup_id",a[0]),e[21].set("virtual_device_id",e[19]==null?"":e[19]),e[21].set("trace_id",a[4]),e[22]=d.toJSON(e[21]),d.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",d.i64.cast([0,50007]),e[22],d.i64.cast([0,0]),d.i64.cast([0,93]),d.i64.cast([0,0]),void 0,e[20]).then(function(a){return a=a,e[23]=a[0],a})},function(b){return d.db.table(185).add({pk:d.i64.cast([0,1]),backupId:a[0],deviceRegistrationId:a[2],taskId:e[23]})},function(a){return d.db.table(179).add({taskId:e[23],virtualDeviceId:e[17],blobDecryptionKey:e[18]})}]):d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. blob_decryption_key is null",!0):d.sequence([function(a){return function(a){d.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. virtual_device_id is null"),e[20]="Invalid recovery code. virtual_device_id is null",function(a){d.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ","",e[20]].join("")),e[19]=d.createArray(),void 0!==void 0?e[21]=(e[19].push(void 0),e[19]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",e[20],e[19],d.i64.cast([0,3]))},function(a){return d.storedProcedure(b("LSHandleWrongRecoveryCode"),void 0,"[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] Invalid recovery code. virtual_device_id is null",!0)}])},function(a){return e[12]=d.i64.cast([0,0])}])},function(a){return e[1]=e[12]}]):d.resolve((function(a){d.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] addDeviceFlow is not enabled"),e[1]=d.i64.cast([0,1])))},function(a){return e[2]=d.i64.of_float(Date.now()),e[3]=d.i64.random(),e[5]="Finishing execution. Execution time: ",e[6]=d.i64.to_string(d.i64.sub(e[2],e[0])),e[7]=" ms",e[4]="",function(a){d.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsAddDeviceStoredProcedure] ",e[4],e[5],e[4],e[6],e[4],e[7]].join("")),d.i64.eq(d.i64.mod_(e[3],d.i64.cast([0,1e3])),d.i64.cast([0,0]))?(e[8]=",",e[9]=d.createArray(),void 0!==void 0?e[10]=(e[9].push(void 0),e[9]):0,d.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsAddDeviceStoredProcedure",[e[5],e[8],e[6],e[8],e[7]].join(""),e[9],d.i64.cast([0,4]))):d.resolve()},function(a){return f[0]=e[1]}])},function(a){return d.resolve(f)}])}a.__sproc_name__="LSEncryptedBackupsAddDeviceStoredProcedure";a.__tables__=["secure_recovery_code_data","pending_tasks","encrypted_backups_virtual_devices","encrypted_backups","secure_encrypted_backups_recovery_code_status","device_metadata"];d=a;g["default"]=d}),98);
__d("LSAddDeviceStoredProcedure",["LSAddDevice","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSAddDevice"),e.backupId,e.recoveryCode,e.deviceRegistrationId,e.backupTenancy,e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("LSEncryptedBackupsRecoveryCodeStatus",[],(function(a,b,c,d,e,f){a=Object.freeze({OPTIMISTIC:1,VALID:2,INVALID:3,SYSTEM_ERROR:4});f["default"]=a}),66);
__d("MWEncryptedBackupsRecoveryCodeStatus",["FBLogger","I64","LSEncryptedBackupsRecoveryCodeStatus"],(function(a,b,c,d,e,f,g){"use strict";var h;function a(a){var b=a.onFailure,e=a.onInvalidRecoveryCode,f=a.onSuccess;a=a.recoveryCodeStatusData;if((a==null?void 0:a.length)!==1)return;a=a[0].recoveryCodeStatus;switch((h||(h=d("I64"))).to_int32(a)){case c("LSEncryptedBackupsRecoveryCodeStatus").OPTIMISTIC:return c("LSEncryptedBackupsRecoveryCodeStatus").OPTIMISTIC;case c("LSEncryptedBackupsRecoveryCodeStatus").INVALID:e==null?void 0:e();return c("LSEncryptedBackupsRecoveryCodeStatus").INVALID;case c("LSEncryptedBackupsRecoveryCodeStatus").VALID:f==null?void 0:f();return c("LSEncryptedBackupsRecoveryCodeStatus").VALID;case c("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR:b==null?void 0:b();return c("LSEncryptedBackupsRecoveryCodeStatus").SYSTEM_ERROR;default:b==null?void 0:b(),c("FBLogger")("labyrinth_web").mustfix("Invalid Recovery Code Status type")}}g.encryptedBackupsGetRecoveryCodeStatus=a}),98);
__d("EBAddDeviceWithRecoveryCode",["EBAPIQPLPoints","EBAPIWorkerCheck","FBLogger","I64","LSAddDeviceStoredProcedure","LSEncryptedBackupsBackupTenancy","LSEncryptedBackupsOpStatus","LSFactory","LSIntEnum","MAWWaitForBackendSetup","MWEncryptedBackupsDeviceRegistrationId","MWEncryptedBackupsInitializeRestoreDeferred","MWEncryptedBackupsRecoveryCodeStatus","Promise","QPLUserFlow","ReQL","WAHashStringToNumber","WALogger","cr:10885","isInstamadilloEB","justknobx","promiseDone","qpl","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device sproc success"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device sproc start"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device gql success"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["[wmi][ebsm] EBAPI add device gql start"]);n=function(){return a};return a}var o=10;function p(a){var e=a.count,f=a.storage;return new(j||(j=b("Promise")))(function(a,b){if(e===o)return a();c("promiseDone")(d("ReQL").firstAsync(d("ReQL").fromTableAscending(f.tables.encrypted_backups)),function(b){b=b==null?void 0:b.backupId;if(b!=null)return a(b);window.setTimeout(function(){a(p({count:e+1,storage:f}))},1e3)},function(a){return b(a)})})}var q=c("qpl")._(521484295,"1460");function a(a){var e=a.environment,g=a.isInWorker,o=a.onFailure,t=a.onInvalidRecoveryCode,u=a.onStart,v=a.onSuccess,w=a.recoveryCode,x=a.storage,y=a.traceId,z=a.trackAddingDevice,A=a.trackOverprompting,B=a.userId,C=function(){},D=!1,E=d("WAHashStringToNumber").hashStringToNumber(c("uuidv4")());a=new(j||(j=b("Promise")))(function(a,b){window.setTimeout(function(){if(D)return;var a="Add device failed by timeout 90 sec";c("FBLogger")("labyrinth_web").warn(a);o("add_device_timeout");s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TIMEOUT,E);b(a)},9e4)});var F=new j(function(a,j){c("QPLUserFlow").start(c("qpl")._(521473756,"2768"),{annotations:{bool:{isBackendSetupOnStart:g?!0:d("MAWWaitForBackendSetup").isBackendSetupSuccessful(),isEBAddDeviceWithKeys:!1,isGraphQL:b("cr:10885")!=null,isInWorker:g}},instanceKey:E,timeoutInMs:c("justknobx")._("4226")}),void A(q),s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ON_START_BEGIN,E,{string:{traceId:y}}),u(),s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ON_START_SUCCESS,E,{string:{traceId:y}}),C=x.tables.secure_encrypted_backups_recovery_code_status.subscribe(function(e,f){if(f.operation==="delete")return;f.operation==="add"&&b("cr:10885")==null&&s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_OPTIMISTIC_STATUS,E);e=[f.value];s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_CHECK_RC_STATUS,E,{string:{traceId:y}});d("MWEncryptedBackupsRecoveryCodeStatus").encryptedBackupsGetRecoveryCodeStatus({onFailure:function(){var a="LSEncryptedBackupsRecoveryCodeStatus system error";r(E,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILED_TO_GET_RC_STATUS,{bool:{is_backend_setup:g?!0:d("MAWWaitForBackendSetup").isBackendSetupSuccessful()},string:{traceId:y}});C();o("add_device_failed_to_get_rc_status");j(a)},onInvalidRecoveryCode:function(){var a="Invalid recovery code";r(E,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.INVALID_RECOVERY_CODE,{bool:{is_backend_setup:g?!0:d("MAWWaitForBackendSetup").isBackendSetupSuccessful()},string:{traceId:y}});C();t();j(a)},onSuccess:function(){c("QPLUserFlow").addAnnotations(c("qpl")._(521473756,"2768"),{bool:{is_backend_setup:g?!0:d("MAWWaitForBackendSetup").isBackendSetupSuccessful()}},{instanceKey:E}),s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_END,E),c("QPLUserFlow").endSuccess(c("qpl")._(521473756,"2768"),{instanceKey:E}),C(),!c("isInstamadilloEB")()?g||d("MWEncryptedBackupsInitializeRestoreDeferred").encryptedBackupsInitializeRestoreDeferred({db:x,onFailure:o,onSuccess:v}):c("QPLUserFlow").endSuccess(q),z()["finally"](function(){v(),a()})},recoveryCodeStatusData:e})}),c("promiseDone")(p({count:0,storage:x}),function(a){if(a!=null)if(b("cr:10885")!=null){d("WALogger").LOG(n());s(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_START,E);var p=!d("EBAPIWorkerCheck").runningInWorker()&&e!=null?b("cr:10885").addDeviceGraphQL({backupId:a,environment:e,qplInstanceKey:E,recoveryCode:w,storage:x,userId:B}):b("cr:10885").addDeviceGraphQLWorker({backupId:a,qplInstanceKey:E,recoveryCode:w,storage:x,userId:B});return p.then(function(a){if(a.success)s(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_END,E),s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_START,E),d("WALogger").LOG(m());else{r(E,d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_FAIL,{bool:{is_backend_setup:g?!0:d("MAWWaitForBackendSetup").isBackendSetupSuccessful()},string:{fail_result:a.error}});s(d("EBAPIQPLPoints").EBAddDeviceGraphqlQPLPoints.ADD_DEVICE_GQL_FAIL,E);C();o("add_device_graphql_error");return j("Add device gql failed")}})}else{d("WALogger").LOG(l());var q=d("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId();if(q===""){r(E,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILED_DEVICE_REGISTRATION_ID_NULL);C();o("deviceRegistrationId is not defied");return j("deviceRegistrationId is not defined")}s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_START,E);return x.runInTransaction(function(b){return c("LSAddDeviceStoredProcedure")(c("LSFactory")(b),{backupId:a,backupTenancy:(h||(h=d("I64"))).of_int32(c("LSEncryptedBackupsBackupTenancy").PRODUCTION),deviceRegistrationId:q,recoveryCode:w})},"readwrite",void 0,void 0,f.id+":330").then(function(a){a=a[0];if(!(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").SUCCESS))){r(E,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_FAILURE,{bool:{is_backend_setup:g?!0:d("MAWWaitForBackendSetup").isBackendSetupSuccessful()}});C();o("add_device_error_add_device_sproc_failure");return j("Add device sproc failed")}s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_SPROC_END,E);s(d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_TASK_START,E);d("WALogger").LOG(k())})["catch"](function(a){c("QPLUserFlow").addAnnotations(c("qpl")._(521473756,"2768"),{string:{error_message:a.message}},{instanceKey:E});throw a})}else{r(E,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_FAILURE_BACKUP_NOT_FOUND);C();o("add_device_error_backup_id_not_defined");return j("backupId is not defined")}},function(a){var b="Add device failed. Could not find backup.";c("FBLogger")("labyrinth_web").catching(a).mustfix(b);r(E,d("EBAPIQPLPoints").EBAddDeviceQPLPoints.ADD_DEVICE_COULD_NOT_FIND_BACKUP,{string:{error_message:a.message}});C();o("add_device_error_could_not_read_backup_table");return j(b)})});return g?F.then(function(){D=!0}):(j||(j=b("Promise"))).race([F,a]).then(function(){D=!0})}var r=function(a,b,d){c("QPLUserFlow").endFailure(c("qpl")._(521473756,"2768"),b,{annotations:d,instanceKey:a})};function s(a,b,d){c("QPLUserFlow").addPoint(c("qpl")._(521473756,"2768"),a,{data:d,instanceKey:b})}g.addDeviceWithRecoveryCode=a}),98);
__d("EBFetchBackupIds",["ExecutionEnvironment","I64","LSAuthorityLevel","LSEncryptedBackupsBackupTenancy","LSFactory","LSFetchBackupIdsStoredProcedure","LSIntEnum","Promise","err","justknobx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k,l=c("justknobx")._("3868");function a(a){return new(k||(k=b("Promise")))(function(b,e){var g,k=a.tables.encrypted_backups.subscribe(function(a,e){if(e.operation==="delete"||!(i||(i=d("I64"))).equal(e.value.authorityLevel,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE)))return;k();window.clearTimeout(g);b()});c("promiseDone")(a.runInTransaction(function(a){return c("LSFetchBackupIdsStoredProcedure")(c("LSFactory")(a),{backupTenancy:(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsBackupTenancy").PRODUCTION),isUiBlocking:!1}).then(function(){g=window.setTimeout(function(){e(c("err")("[wmi][ebapi] Timeout fetching backup ids, isInWorker: "+(h||(h=c("ExecutionEnvironment"))).isInWorker.toString()))},l)})},"readwrite",void 0,void 0,f.id+":51"))})}g.fetchBackupIds=a}),98);
__d("EBGetEBStateQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="23909871918604871"}),null);
__d("EBGetEBStateQuery.graphql",["EBGetEBStateQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null};a={alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:[{kind:"Literal",name:"family_device_id",value:""}],kind:"ScalarField",name:"has_otc_eligible_devices",storageKey:'has_otc_eligible_devices(family_device_id:"")'},{alias:null,args:null,kind:"ScalarField",name:"has_seen_eb_auto_restore_notice",storageKey:null},a,{alias:null,args:null,kind:"ScalarField",name:"is_user_opted_out",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_creation_time",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_tenancy",storageKey:null},{alias:null,args:null,concreteType:"XFBEBVirtualDevice",kind:"LinkedField",name:"virtual_devices",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"creation_time",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"device_created_on",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"device_type",storageKey:null},a,{alias:null,args:null,kind:"ScalarField",name:"migration_status",storageKey:null}],storageKey:null}],storageKey:null},{kind:"ClientExtension",selections:[{alias:null,args:null,kind:"ScalarField",name:"backup_state",storageKey:null}]}],storageKey:null};return{fragment:{argumentDefinitions:[],kind:"Fragment",metadata:null,name:"EBGetEBStateQuery",selections:[{kind:"RequiredField",field:a,action:"LOG",path:"viewer"}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[],kind:"Operation",name:"EBGetEBStateQuery",selections:[a]},params:{id:b("EBGetEBStateQuery_facebookRelayOperation"),metadata:{},name:"EBGetEBStateQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBGetEBState",["EBGetEBStateQuery.graphql","FBLogger","MAWOneTimeCodeGating","RelayHooks","WAResultOrError","XPlatRelayEnvironment"],(function(a,b,c,d,e,f,g){"use strict";var h,i=h!==void 0?h:h=b("EBGetEBStateQuery.graphql");async function a(){try{var a,b,e=await d("RelayHooks").fetchQuery(d("XPlatRelayEnvironment").getRelayEnvironment(),i,{}).toPromise().then(function(a){return a});a=e==null?void 0:(a=e.viewer)==null?void 0:a.backup_state;if(a===1||a===0)return d("WAResultOrError").makeResult({backupStatus:a});a=(a=e==null?void 0:(a=e.viewer)==null?void 0:(a=a.encrypted_backup)==null?void 0:a.virtual_devices)!=null?a:[];var f=a.filter(function(a){return a.device_type==="HSM"});a=a.filter(function(a){return a.device_type===1});return d("WAResultOrError").makeResult({backupStatus:(e==null?void 0:(b=e.viewer)==null?void 0:b.backup_state)!=null?e.viewer.backup_state:0,ebState:{backupMetadata:{backupId:(b=e==null?void 0:(b=e.viewer)==null?void 0:(b=b.encrypted_backup)==null?void 0:b.id)!=null?b:"",creationTime:(b=e==null?void 0:(b=e.viewer)==null?void 0:(b=b.encrypted_backup)==null?void 0:b.backup_creation_time)!=null?b:0,deviceCreatedOn:(b=f[0].device_created_on)!=null?b:"",removalStatus:"",requiresHsmMigration:f[0].migration_status!=="DOES_NOT_REQUIRE_MIGRATION",virtualDeviceCreationTime:(b=(b=f[0])==null?void 0:b.creation_time)!=null?b:0,virtualDeviceId:(b=(b=f[0])==null?void 0:b.id)!=null?b:"",virtualDeviceType:(b=(b=f[0])==null?void 0:b.device_type)!=null?b:""},backupTenancy:(b=e==null?void 0:(b=e.viewer)==null?void 0:(b=b.encrypted_backup)==null?void 0:b.backup_tenancy)!=null?b:"PRODUCTION",hasOtcEligibleDevices:!!(d("MAWOneTimeCodeGating").isOneTimeCodeEnabled&&(e==null?void 0:(b=e.viewer)==null?void 0:(b=b.encrypted_backup)==null?void 0:b.has_otc_eligible_devices)!==!1),hasSeenEbAutoRestoreNotice:(b=e==null?void 0:(b=e.viewer)==null?void 0:(b=b.encrypted_backup)==null?void 0:b.has_seen_eb_auto_restore_notice)!=null?b:!1,isPINCodeRegistered:((b=f[0])==null?void 0:b.id)!=null,isUserOptedOut:(e=e==null?void 0:(f=e.viewer)==null?void 0:(b=f.encrypted_backup)==null?void 0:b.is_user_opted_out)!=null?e:!1,offlineDevicesCount:a.length}})}catch(a){c("FBLogger")("labyrinth_web").catching(a).mustfix("Failed to check EB enabled");return d("WAResultOrError").makeResult({backupStatus:0})}}g.GetEbState=a}),98);
__d("EBGetLatestChatJids",["I64","MAWBridgeSafeActionsWorkerAndUI","ReQL","WAResultOrError","getErrorSafe"],(function(a,b,c,d,e,f,g){"use strict";var h,i=50;async function a(a,b){b===void 0&&(b=i);try{b=await d("MAWBridgeSafeActionsWorkerAndUI").sendAndReceiveBackendWorkerAndUIShared("getLatestChatJids",{count:b});a=await a.runInTransaction(function(a){return d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.mi_act_mapping_table).map(function(a){a=a.jid;return(h||(h=d("I64"))).to_string(a)}))},"readonly",void 0,void 0,f.id+":47");var e=[];if(a.length>0){var g=new Set(a);b.forEach(function(a){var b=a.split("@")[0];g.has(b)&&e.push(a)})}return d("WAResultOrError").makeResult(e)}catch(a){return d("WAResultOrError").makeError(c("getErrorSafe")(a))}}g.getLatestChatJids=a}),98);
__d("EBMinosWasmOpenEpoch",["EBGetMinosWasm","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","WACreateWasmFunction","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.getWasmModule;a=a.logger;var c=a.TAGS(["open-epoch"]);function e(a){var b;a=a.minosSignedEpoch;var c=a.epochHead,e=a.epochPublicData;a=a.signatures;return d("WAResultOrError").makeResult({epochHead:(b=d("EBMinosTypes")).unsafeCastToEpochHead(c),epochPublicData:{epochNumber:b.unsafeCastToEpochNumber(e.epochNumber),mailboxAuthPk:b.unsafeCastToMailboxAuthPK(e.mailboxAuthPk),mailboxEncryptionPk:b.unsafeCastToMailboxEncryptionPK(e.mailboxEncryptionPk),mailboxSigningPk:b.unsafeCastToMailboxSigningPK(e.mailboxSigningPk),previousEpochHead:e.previousEpochHead==null?null:d("EBMinosTypes").unsafeCastToEpochHead(e.previousEpochHead),userFbid:d("EBMinosTypes").unsafeCastToUserFbId(e.userFbid)},signatures:{prevSignature:a.prevSignature==null?null:d("EBMinosTypes").unsafeCastToEpochSignature(a.prevSignature),selfSignature:d("EBMinosTypes").unsafeCastToEpochSignature(a.selfSignature)}})}return async function(a){var f=a.epochNumber,g=a.exportRootKey,h=a.previousEpochHead,i=a.previousEpochNumber,j=a.previousExportRootKey;a=a.userFbid;var k=d("WACreateWasmFunction").createWasmFunction({InputSpec:d("EBMinosWasm.pb").MinosOpenEpochInputSpec,ResultSpec:d("EBMinosWasm.pb").MinosOpenEpochResultSpec,cli:"minos_cli",command:"minos-open-epoch",getWasmModule:b,logger:c,validateResult:e});k=await k({epochNumber:f,exportRootKey:g,previousEpochHead:h,previousEpochNumber:i,previousExportRootKey:j,userFbid:a});return k}}b=a({getWasmModule:d("EBGetMinosWasm").getMinosWasm,logger:d("EBMinosLogger").minosLogger});g.openEpoch=b}),98);
__d("EBMinosCreateMinosEpochParams",["EBMinosLogger","EBMinosTypes","EBMinosWasmOpenEpoch","WALongInt","WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Created minos epoch params successfully"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to open epoch ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["TODO implement minos_open_initial_epoch"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["start creating minos epoch params"]);k=function(){return a};return a}async function a(a){var b=a.epochAnonId,c=a.epochRootKeyBlob,e=a.previousEpochAnonId,f=a.previousEpochHead,g=a.previousEpochRootKeyBlob;a=a.rawUserFbid;d("EBMinosLogger").minosLogger.DEV(k());a=d("EBMinosTypes").unsafeCastToUserFbId(a);b=d("EBMinosTypes").unsafeCastToEpochNumber(d("WALongInt").decimalStringToLongInt(new TextDecoder().decode(b)));var l=d("EBMinosTypes").unsafeCastToExportRootKey(c);e=e==null?null:d("EBMinosTypes").unsafeCastToEpochNumber(d("WALongInt").decimalStringToLongInt(new TextDecoder().decode(e)));g=g==null?null:d("EBMinosTypes").unsafeCastToExportRootKey(c);if(e==null||g==null||f==null){d("EBMinosLogger").minosLogger.DEV(j());return d("WAResultOrError").makeError({errorName:"not-implemented"})}c=await d("EBMinosWasmOpenEpoch").openEpoch({epochNumber:b,exportRootKey:l,previousEpochHead:d("EBMinosTypes").unsafeCastToEpochHead(f),previousEpochNumber:e,previousExportRootKey:g,userFbid:a});if(!c.success){d("EBMinosLogger").minosLogger.ERROR(i(),c.error);return d("WAResultOrError").makeError({errorName:"open-epoch-failed",failReason:c.error})}d("EBMinosLogger").minosLogger.DEV(h());return Promise.resolve(d("WAResultOrError").makeResult({epochHead:c.value.epochHead,mailboxAuthPk:c.value.epochPublicData.mailboxAuthPk,mailboxEncryptionPk:c.value.epochPublicData.mailboxEncryptionPk,mailboxSigningPk:c.value.epochPublicData.mailboxSigningPk,previousEpochSignature:c.value.signatures.prevSignature,selfEpochSignature:c.value.signatures.selfSignature}))}g.createMinosEpochParamsType=a}),98);
__d("LSCreateMinosEpochParams.nop",["EBMinosCreateMinosEpochParams","MAWCurrentUser","err"],(function(a,b,c,d,e,f,g){"use strict";a=async function(a,b,e,f,g,h,i){a=await d("EBMinosCreateMinosEpochParams").createMinosEpochParamsType({epochAnonId:f,epochRootKeyBlob:e,previousEpochAnonId:h,previousEpochHead:i,previousEpochRootKeyBlob:g,rawUserFbid:d("MAWCurrentUser").getID()});if(!a.success){if(a.error.errorName==="not-implemented")return Promise.resolve([new ArrayBuffer(32),new ArrayBuffer(32),new ArrayBuffer(32),new ArrayBuffer(32),new ArrayBuffer(32),void 0]);throw c("err")("createMinosEpochParamsType error: "+a.error.errorName+" "+((b=a.error.failReason)!=null?b:""))}return Promise.resolve([a.value.mailboxEncryptionPk,a.value.mailboxSigningPk,a.value.mailboxAuthPk,a.value.epochHead,a.value.selfEpochSignature,(f=a.value.previousEpochSignature)!=null?f:void 0])};a.__nop_name__="LSCreateMinosEpochParamsType";g.default=a}),98);
__d("LSOcmfClientInit_v2.nop",["CryptoLogger","LSResult","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h=c("requireDeferred")("ristretto255").__setRef("LSOcmfClientInit_v2.nop");a=function(a,b){return h.load().then(function(a){return c("LSResult")(a.scalar.getRandom().buffer)})["catch"](function(a){d("CryptoLogger").captureError(d("CryptoLogger").CryptoLogger("ocmf_client_init_v2"),a).mustfix("Failed to init OCMF client.");throw a})};a.__nop_name__="LSOcmfClientInit_v2";g["default"]=a}),98);
__d("LSRandom.nop",["CryptoLogger","I64","LSMaxInt32","LSResult","Promise","XPlatReactCrypto"],(function(a,b,c,d,e,f,g){"use strict";var h,i;a=function(a,e,f){a=d("CryptoLogger").CryptoLogger("ope_encrypt");if((i||(i=d("I64"))).gt(f,c("LSMaxInt32"))){a.mustfix("numBytes '"+String(f)+"' too large. Returning an empty array");return(h||(h=b("Promise"))).resolve(c("LSResult")(new Uint8Array(0).buffer))}e=(i||(i=d("I64"))).to_int32(f);a=new Uint8Array(e);f=65536;for(var g=0;g<e;g+=f){var j=a.subarray(g,g+Math.min(e-g,f));d("XPlatReactCrypto").getRandomValues(j)}return(h||(h=b("Promise"))).resolve(c("LSResult")(a.buffer))};a.__nop_name__="LSRandom";g["default"]=a}),98);
__d("LSGenerateInitialDeviceSetupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateAuthKeyPair.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignature_v2.nop","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientInit_v2.nop","LSOcmfClientMap.nop","LSRandom.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][generateInitialDeviceSetupPayload] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[32]=new c.Map(),d[32].set("error_msg","Expected a nonempty query result"),d[32].set("code",c.i64.cast([0,3])),d[32].set("src_line","MEBClientStateUtils.php:244 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[33]=c.createArray(),d[34]=(d[33].push(d[32]),d[33]),e=[void 0,d[33]],d[2]=e[0],d[3]=e[1],e):(b=a.item,d[32]=new c.Map(),d[32].set("backup_id",b.backupId),d[32].set("device_public_key_blob",b.devicePublicKeyBlob),d[32].set("device_private_key_blob",b.devicePrivateKeyBlob),d[32].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[32].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[32].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[32].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[32].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[32].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[32].set("orf_client_state_v2_blob",void 0),d[32].set("orf_v2_authority_level",void 0),d[32].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[32].set("device_id",b.deviceId),d[32].set("backup_tenancy",b.backupTenancy),d[32].set("encryption_version",b.encryptionVersion),d[32].set("revision_version",b.revisionVersion),d[32].set("initialize_restore_result",void 0),d[32].set("authority_level",b.authorityLevel),e=[d[32],void 0],d[2]=e[0],d[3]=e[1],e)})},function(a){return d[5]=new c.Map(),d[5].set("value",d[2]),d[5].set("errors",d[3]),d[6]=d[5].get("value"),d[6]!==void 0?c.sequence([function(a){return d[32]=d[6].get("backup_id"),d[33]=d[6].get("device_public_key_blob"),d[34]=d[6].get("device_private_key_blob"),d[35]=d[6].get("epoch_storage_public_key_blob"),d[36]=d[6].get("epoch_storage_private_key_blob"),d[37]=d[6].get("epoch_auth_public_key_blob"),d[38]=d[6].get("epoch_auth_private_key_blob"),d[39]=d[6].get("mailbox_root_key_blob"),d[40]=d[6].get("ocmf_client_state_blob"),d[41]=d[6].get("orf_client_state_v2_blob"),d[42]=d[6].get("orf_v2_authority_level"),d[43]=d[6].get("oblivious_validation_token_blob"),d[44]=d[6].get("device_id"),d[45]=d[6].get("backup_tenancy"),d[46]=d[6].get("encryption_version"),d[47]=d[6].get("revision_version"),d[48]=d[6].get("initialize_restore_result"),d[49]=d[6].get("authority_level"),c.i64.neq(d[44],void 0)?c.sequence([function(a){return d[67]=void 0,c.i64.neq(d[67],void 0)?c.resolve(d[68]=d[67]):c.sequence([function(a){return d[71]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[72]=a[0],a})},function(a){return d[72]?d[81]=(d[71].push(c.i64.cast([0,0])),d[71]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[73]=a[0],a})},function(a){return d[73]?d[81]=(d[71].push(c.i64.cast([0,2])),d[71]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[74]=a[0],a})},function(a){return d[74]?d[81]=(d[71].push(c.i64.cast([0,3])),d[71]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[75]=a[0],a})},function(a){return d[75]?d[81]=(d[71].push(c.i64.cast([0,4])),d[71]):0,d[76]=c.createArray(),d[77]=c.i64.of_int32(d[71].length),c.i64.gt(d[77],c.i64.cast([0,0]))?c.loopAsync(d[77],function(a){return d[81]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[71],d[81]).then(function(a){return a=a,d[82]=a[0],d[83]=a[1],a})},function(a){return d[84]=(d[76].push(d[82]),d[76])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[81]=c.createArray(),d[82]=c.i64.of_int32(d[76].length),c.i64.gt(d[82],c.i64.cast([0,0]))?c.loopAsync(d[82],function(a){return d[84]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[76],d[84]).then(function(a){return a=a,d[85]=a[0],d[86]=a[1],a})},function(a){return d[87]=(d[81].push(c.i64.to_string(d[85])),d[81])}])}):c.resolve()},function(a){return d[83]=d[81].join(","),d[78]=d[83]}])},function(a){return d[76].some(function(a){return c.i64.eq(d[46],a)})?d[79]=d[46]:d[79]=void 0,c.i64.neq(d[79],void 0)?d[80]=d[79]:d[80]=void 0,d[68]=d[80]}])},function(a){return c.i64.neq(d[68],void 0)?d[69]=d[68]:d[69]=c.i64.cast([0,0]),c.i64.neq(d[45],void 0)?d[70]=d[45]:d[70]=c.i64.cast([0,1]),a=[d[32],d[44],d[39],d[40],void 0,void 0,d[69],d[70],d[37],d[38],d[33],d[34],d[35],d[36],d[43],d[49],void 0],d[50]=a[0],d[51]=a[1],d[52]=a[2],d[53]=a[3],d[54]=a[4],d[55]=a[5],d[56]=a[6],d[57]=a[7],d[58]=a[8],d[59]=a[9],d[60]=a[10],d[61]=a[11],d[62]=a[12],d[63]=a[13],d[64]=a[14],d[65]=a[15],d[66]=a[16],a}]):c.sequence([function(a){return c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})},function(a){return d[67]=c.i64.random(),d[68]=c.i64.random(),c.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,d[69]=a[0],d[70]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,d[71]=a[0],d[72]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateAuthKeyPair.nop")).then(function(a){return a=a,d[73]=a[0],d[74]=a[1],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[75]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[76]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[77]=a[0],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[78]=a[0],a})},function(a){return d[79]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[80]=a[0],a})},function(a){return d[80]?d[105]=(d[79].push(c.i64.cast([0,0])),d[79]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[81]?d[105]=(d[79].push(c.i64.cast([0,2])),d[79]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[82]=a[0],a})},function(a){return d[82]?d[105]=(d[79].push(c.i64.cast([0,3])),d[79]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[83]?d[105]=(d[79].push(c.i64.cast([0,4])),d[79]):0,d[84]=c.i64.of_int32(d[79].length),c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[79],c.i64.sub(d[84],c.i64.cast([0,1]))).then(function(a){return a=a,d[85]=a[0],d[86]=a[1],a})},function(a){return c.forEach(c.filter(c.db.table(168).fetch([[[d[67]]]]),function(a){return c.i64.eq(a.backupId,d[67])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(a){return c.db.table(168).add({backupId:d[67],deviceId:d[68],devicePublicKeyBlob:d[70],devicePrivateKeyBlob:d[69],epochStoragePublicKeyBlob:d[72],epochStoragePrivateKeyBlob:d[71],epochAuthPublicKeyBlob:d[74],epochAuthPrivateKeyBlob:d[73],mailboxRootKeyBlob:d[75],ocmfClientStateBlob:d[76],obliviousValidationTokenBlob:d[78],authorityLevel:c.i64.cast([0,20]),encryptionVersion:d[85],revisionVersion:c.i64.cast([0,1]),backupTenancy:c.i64.cast([0,1])})},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,20]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0],d[87]=f[0],d[88]=f[1],d[89]=f[2],d[90]=f[3],d[91]=f[4],d[92]=f[5],d[93]=f[6],d[94]=f[7],d[95]=f[8],d[96]=f[9],d[97]=f[10],d[98]=f[11],d[99]=f[12],d[100]=f[13],d[101]=f[14],d[102]=f[15],d[103]=f[16],f):(e=a.item,c.sequence([function(a){return d[110]=e.backupTenancy,d[109]=e.encryptionVersion,d[105]=void 0,c.i64.neq(d[105],void 0)?c.resolve(d[106]=d[105]):c.sequence([function(a){return d[111]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[112]=a[0],a})},function(a){return d[112]?d[121]=(d[111].push(c.i64.cast([0,0])),d[111]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[113]=a[0],a})},function(a){return d[113]?d[121]=(d[111].push(c.i64.cast([0,2])),d[111]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[114]=a[0],a})},function(a){return d[114]?d[121]=(d[111].push(c.i64.cast([0,3])),d[111]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[115]=a[0],a})},function(a){return d[115]?d[121]=(d[111].push(c.i64.cast([0,4])),d[111]):0,d[116]=c.createArray(),d[117]=c.i64.of_int32(d[111].length),c.i64.gt(d[117],c.i64.cast([0,0]))?c.loopAsync(d[117],function(a){return d[121]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[111],d[121]).then(function(a){return a=a,d[122]=a[0],d[123]=a[1],a})},function(a){return d[124]=(d[116].push(d[122]),d[116])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[121]=c.createArray(),d[122]=c.i64.of_int32(d[116].length),c.i64.gt(d[122],c.i64.cast([0,0]))?c.loopAsync(d[122],function(a){return d[124]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[116],d[124]).then(function(a){return a=a,d[125]=a[0],d[126]=a[1],a})},function(a){return d[127]=(d[121].push(c.i64.to_string(d[125])),d[121])}])}):c.resolve()},function(a){return d[123]=d[121].join(","),d[118]=d[123]}])},function(a){return d[116].some(function(a){return c.i64.eq(d[109],a)})?d[119]=d[109]:d[119]=void 0,c.i64.neq(d[119],void 0)?d[120]=d[119]:d[120]=void 0,d[106]=d[120]}])},function(a){return c.i64.neq(d[106],void 0)?d[107]=d[106]:d[107]=c.i64.cast([0,0]),c.i64.neq(d[110],void 0)?d[108]=d[110]:d[108]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[107],d[108],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0],d[87]=a[0],d[88]=a[1],d[89]=a[2],d[90]=a[3],d[91]=a[4],d[92]=a[5],d[93]=a[6],d[94]=a[7],d[95]=a[8],d[96]=a[9],d[97]=a[10],d[98]=a[11],d[99]=a[12],d[100]=a[13],d[101]=a[14],d[102]=a[15],d[103]=a[16],a}]))})},function(a){return a=[d[87],d[88],d[89],d[90],d[91],d[92],d[93],d[94],d[95],d[96],d[97],d[98],d[99],d[100],d[101],d[102],d[103]],d[50]=a[0],d[51]=a[1],d[52]=a[2],d[53]=a[3],d[54]=a[4],d[55]=a[5],d[56]=a[6],d[57]=a[7],d[58]=a[8],d[59]=a[9],d[60]=a[10],d[61]=a[11],d[62]=a[12],d[63]=a[13],d[64]=a[14],d[65]=a[15],d[66]=a[16],a}])},function(a){return a=[d[50],d[51],d[52],d[53],d[54],d[55],d[56],d[57],d[58],d[59],d[60],d[61],d[62],d[63],d[64],d[65],d[66]],d[7]=a[0],d[8]=a[1],d[9]=a[2],d[10]=a[3],d[11]=a[4],d[12]=a[5],d[13]=a[6],d[14]=a[7],d[15]=a[8],d[16]=a[9],d[17]=a[10],d[18]=a[11],d[19]=a[12],d[20]=a[13],d[21]=a[14],d[22]=a[15],d[23]=a[16],a}]):c.sequence([function(a){return d[32]=d[5].get("errors"),d[33]=d[5].get("errors"),c.forEach(c.db.table(169).fetch(),function(a){return a["delete"]()})},function(a){return d[34]=c.i64.random(),d[35]=c.i64.random(),c.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,d[36]=a[0],d[37]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,d[38]=a[0],d[39]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateAuthKeyPair.nop")).then(function(a){return a=a,d[40]=a[0],d[41]=a[1],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[42]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[43]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientInit_v2.nop")).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSRandom.nop"),c.i64.cast([0,32])).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[46]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[72]=(d[46].push(c.i64.cast([0,0])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[72]=(d[46].push(c.i64.cast([0,2])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[72]=(d[46].push(c.i64.cast([0,3])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[72]=(d[46].push(c.i64.cast([0,4])),d[46]):0,d[51]=c.i64.of_int32(d[46].length),c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],c.i64.sub(d[51],c.i64.cast([0,1]))).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return c.forEach(c.filter(c.db.table(168).fetch([[[d[34]]]]),function(a){return c.i64.eq(a.backupId,d[34])&&c.i64.lt(a.authorityLevel,c.i64.cast([0,20]))}),function(a){return a["delete"]()})},function(a){return c.db.table(168).add({backupId:d[34],deviceId:d[35],devicePublicKeyBlob:d[37],devicePrivateKeyBlob:d[36],epochStoragePublicKeyBlob:d[39],epochStoragePrivateKeyBlob:d[38],epochAuthPublicKeyBlob:d[41],epochAuthPrivateKeyBlob:d[40],mailboxRootKeyBlob:d[42],ocmfClientStateBlob:d[43],obliviousValidationTokenBlob:d[45],authorityLevel:c.i64.cast([0,20]),encryptionVersion:d[52],revisionVersion:c.i64.cast([0,1]),backupTenancy:c.i64.cast([0,1])})},function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,20]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0],d[54]=f[0],d[55]=f[1],d[56]=f[2],d[57]=f[3],d[58]=f[4],d[59]=f[5],d[60]=f[6],d[61]=f[7],d[62]=f[8],d[63]=f[9],d[64]=f[10],d[65]=f[11],d[66]=f[12],d[67]=f[13],d[68]=f[14],d[69]=f[15],d[70]=f[16],f):(e=a.item,c.sequence([function(a){return d[77]=e.backupTenancy,d[76]=e.encryptionVersion,d[72]=void 0,c.i64.neq(d[72],void 0)?c.resolve(d[73]=d[72]):c.sequence([function(a){return d[78]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[79]=a[0],a})},function(a){return d[79]?d[88]=(d[78].push(c.i64.cast([0,0])),d[78]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[80]=a[0],a})},function(a){return d[80]?d[88]=(d[78].push(c.i64.cast([0,2])),d[78]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[81]?d[88]=(d[78].push(c.i64.cast([0,3])),d[78]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[82]=a[0],a})},function(a){return d[82]?d[88]=(d[78].push(c.i64.cast([0,4])),d[78]):0,d[83]=c.createArray(),d[84]=c.i64.of_int32(d[78].length),c.i64.gt(d[84],c.i64.cast([0,0]))?c.loopAsync(d[84],function(a){return d[88]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[78],d[88]).then(function(a){return a=a,d[89]=a[0],d[90]=a[1],a})},function(a){return d[91]=(d[83].push(d[89]),d[83])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[88]=c.createArray(),d[89]=c.i64.of_int32(d[83].length),c.i64.gt(d[89],c.i64.cast([0,0]))?c.loopAsync(d[89],function(a){return d[91]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[83],d[91]).then(function(a){return a=a,d[92]=a[0],d[93]=a[1],a})},function(a){return d[94]=(d[88].push(c.i64.to_string(d[92])),d[88])}])}):c.resolve()},function(a){return d[90]=d[88].join(","),d[85]=d[90]}])},function(a){return d[83].some(function(a){return c.i64.eq(d[76],a)})?d[86]=d[76]:d[86]=void 0,c.i64.neq(d[86],void 0)?d[87]=d[86]:d[87]=void 0,d[73]=d[87]}])},function(a){return c.i64.neq(d[73],void 0)?d[74]=d[73]:d[74]=c.i64.cast([0,0]),c.i64.neq(d[77],void 0)?d[75]=d[77]:d[75]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[74],d[75],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0],d[54]=a[0],d[55]=a[1],d[56]=a[2],d[57]=a[3],d[58]=a[4],d[59]=a[5],d[60]=a[6],d[61]=a[7],d[62]=a[8],d[63]=a[9],d[64]=a[10],d[65]=a[11],d[66]=a[12],d[67]=a[13],d[68]=a[14],d[69]=a[15],d[70]=a[16],a}]))})},function(a){return a=[d[54],d[55],d[56],d[57],d[58],d[59],d[60],d[61],d[62],d[63],d[64],d[65],d[66],d[67],d[68],d[69],d[70]],d[7]=a[0],d[8]=a[1],d[9]=a[2],d[10]=a[3],d[11]=a[4],d[12]=a[5],d[13]=a[6],d[14]=a[7],d[15]=a[8],d[16]=a[9],d[17]=a[10],d[18]=a[11],d[19]=a[12],d[20]=a[13],d[21]=a[14],d[22]=a[15],d[23]=a[16],a}])},function(e){return c.i64.neq(d[7],void 0)?c.sequence([function(e){return c.blobs.neq(d[18],void 0)?c.sequence([function(e){return c.blobs.neq(d[17],void 0)?c.sequence([function(e){return c.blobs.neq(d[19],void 0)?c.sequence([function(e){return c.blobs.neq(d[15],void 0)?c.sequence([function(e){return c.blobs.neq(d[10],void 0)?c.sequence([function(e){return c.blobs.neq(d[9],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[18],c.blob("MA=="),d[19]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[18],c.blob("MQ=="),d[15]).then(function(a){return a=a,d[45]=a[0],a})},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),c.i64.to_string(d[7])).then(function(a){return a=a,d[46]=a[0],a})},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),c.blob("bWFpbGJveF9pZF9zY29wZQ=="),d[46]).then(function(a){return a=a,d[47]=a[0],a})},function(a){return c.nativeOperation(b("LSOcmfClientMap.nop"),d[10],d[47]).then(function(a){return a=a,d[48]=a[0],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[48]).then(function(a){return a=a,d[49]=a[0],a})},function(b){return d[50]=new c.Map(),d[50].set("optimistic_backup_id",d[7]),d[50].set("device_private_key",d[18]),d[50].set("device_public_key",d[17]),d[50].set("epoch_storage_public_key",d[19]),d[50].set("epoch_storage_public_key_sig",d[44]==null?c.blob("bnVsbA=="):d[44]),d[50].set("epoch_auth_public_key",d[15]),d[50].set("epoch_auth_public_key_sig",d[45]==null?c.blob("bnVsbA=="):d[45]),d[50].set("ocmf_client_state",d[10]),d[50].set("mailbox_partial_id",d[49]==null?"":d[49]),d[50].set("mailbox_root_key",d[9]),d[50].set("device_registration_id",a[0]),d[50].set("orf_client_state_v2",void 0),b=[d[50],void 0],d[42]=b[0],d[43]=b[1],b}]):c.resolve((d[44]=new c.Map(),d[44].set("error_code",c.i64.cast([0,9])),d[44].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[44].set("error_message",""),e=[void 0,d[44]],d[42]=e[0],d[43]=e[1],e))},function(a){return a=[d[42],d[43]],d[40]=a[0],d[41]=a[1],a}]):c.resolve((d[42]=new c.Map(),d[42].set("error_code",c.i64.cast([0,9])),d[42].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[42].set("error_message",""),e=[void 0,d[42]],d[40]=e[0],d[41]=e[1],e))},function(a){return a=[d[40],d[41]],d[38]=a[0],d[39]=a[1],a}]):c.resolve((d[40]=new c.Map(),d[40].set("error_code",c.i64.cast([0,9])),d[40].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[40].set("error_message",""),e=[void 0,d[40]],d[38]=e[0],d[39]=e[1],e))},function(a){return a=[d[38],d[39]],d[36]=a[0],d[37]=a[1],a}]):c.resolve((d[38]=new c.Map(),d[38].set("error_code",c.i64.cast([0,9])),d[38].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[38].set("error_message",""),e=[void 0,d[38]],d[36]=e[0],d[37]=e[1],e))},function(a){return a=[d[36],d[37]],d[34]=a[0],d[35]=a[1],a}]):c.resolve((d[36]=new c.Map(),d[36].set("error_code",c.i64.cast([0,9])),d[36].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[36].set("error_message",""),e=[void 0,d[36]],d[34]=e[0],d[35]=e[1],e))},function(a){return a=[d[34],d[35]],d[32]=a[0],d[33]=a[1],a}]):c.resolve((d[34]=new c.Map(),d[34].set("error_code",c.i64.cast([0,9])),d[34].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[34].set("error_message",""),e=[void 0,d[34]],d[32]=e[0],d[33]=e[1],e))},function(a){return a=[d[32],d[33]],d[24]=a[0],d[25]=a[1],a}]):c.resolve((d[32]=new c.Map(),d[32].set("error_code",c.i64.cast([0,9])),d[32].set("stored_procedure","LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure"),d[32].set("error_message",""),e=[void 0,d[32]],d[24]=e[0],d[25]=e[1],e))},function(a){return d[26]=c.i64.of_float(Date.now()),d[27]=c.i64.random(),d[29]="Finishing execution. Execution time: ",d[30]=c.i64.to_string(c.i64.sub(d[26],d[0])),d[31]=" ms",d[28]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][generateInitialDeviceSetupPayload] ",d[28],d[29],d[28],d[30],d[28],d[31]].join("")),c.i64.eq(c.i64.mod_(d[27],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[32]=",",d[33]=c.createArray(),void 0!==void 0?d[34]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"generateInitialDeviceSetupPayload",[d[29],d[32],d[30],d[32],d[31]].join(""),d[33],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[24],d[25]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGenerateInitialDeviceSetupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_client_state","secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSCreateSymmetricEncryptionSecretKey.nop",["CryptoLogger","LSResult","Promise","XPlatReactCrypto"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a,e){return(h||(h=b("Promise"))).resolve(c("LSResult")(d("XPlatReactCrypto").getRandomValues(new Uint8Array(32)).buffer))["catch"](function(a){d("CryptoLogger").captureError(d("CryptoLogger").CryptoLogger("create_symmetric_encryption_secret_key"),a).mustfix("Creation of symmetric encryption secret key failed");throw a})};a.__nop_name__="LSCreateSymmetricEncryptionSecretKey";g["default"]=a}),98);
__d("LSGenerateInitialEpochSetupPayload",["LSCreateMinosEpochParams.nop","LSCreateSymmetricEncryptionSecretKey.nop","LSGetNextEpochAnonId.nop","LSLogMebClientEvent.nop","LSStoreEpoch"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][generateInitialEpochSetupPayload] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.filter(c.db.table(169).fetch(),function(a){return c.i64.eq(a.epochStatus,c.i64.cast([0,1]))&&c.i64.eq(a.authorityLevel,c.i64.cast([0,20]))}).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(a){return function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure] Generating new initial epoch."),c.nativeOperation(b("LSGetNextEpochAnonId.nop"),void 0).then(function(a){return a=a,d[16]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateSymmetricEncryptionSecretKey.nop")).then(function(a){return a=a,d[17]=a[0],a})},function(a){return c.sequence([function(a){return c.nativeOperation(b("LSCreateMinosEpochParams.nop"),d[17],d[16],void 0,void 0,void 0).then(function(a){return a=a,d[20]=a[0],d[21]=a[1],d[22]=a[2],d[23]=a[3],d[24]=a[4],d[25]=a[5],a})},function(a){return d[18]=d[23]}])},function(e){return d[19]=c.i64.random(),c.storedProcedure(b("LSStoreEpoch"),d[19],a[0],d[16],d[17],c.i64.cast([0,1]),c.i64.cast([0,20]),!1)},function(a){return a=[d[19],d[16],d[17],void 0,void 0,d[18]],d[2]=a[0],d[3]=a[1],d[4]=a[2],d[5]=a[3],d[6]=a[4],d[7]=a[5],a}]):(f=e.item,function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure] Using local optimistic initial epoch."),g=[f.epochId,f.epochAnonIdBlob,f.epochRootKeyBlob,void 0,void 0,f.epochHead],d[2]=g[0],d[3]=g[1],d[4]=g[2],d[5]=g[3],d[6]=g[4],d[7]=g[5],g)})},function(a){return d[9]=new c.Map(),d[9].set("optimistic_epoch_id",d[2]),d[9].set("epoch_anon_id",d[3]),d[9].set("epoch_root_key",d[4]),d[10]=c.i64.of_float(Date.now()),d[11]=c.i64.random(),d[13]="Finishing execution. Execution time: ",d[14]=c.i64.to_string(c.i64.sub(d[10],d[0])),d[15]=" ms",d[12]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][generateInitialEpochSetupPayload] ",d[12],d[13],d[12],d[14],d[12],d[15]].join("")),c.i64.eq(c.i64.mod_(d[11],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[16]=",",d[17]=c.createArray(),void 0!==void 0?d[18]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"generateInitialEpochSetupPayload",[d[13],d[16],d[14],d[16],d[15]].join(""),d[17],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[9],void 0],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGenerateInitialEpochSetupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSGetOpenEpochKeys",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSDeleteBackupOnClient","LSIsMobileClient","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(b){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Beginning execution."),d[11]="Querying latest epoch keys with authority level: ",a[0]?d[1]="OPTIMISTIC":d[1]="AUTHORITATIVE",d[2]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",d[2],d[11],d[2],d[1]].join("")),c.resolve()},function(e){return a[0]?d[3]="OPTIMISTIC":d[3]="AUTHORITATIVE",c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2842]),c.i64.cast([0,2]),void 0,d[3]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2844]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}])},function(b){return d[4]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch(),function(b){return a[0]||c.i64.eq(b.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[16]=(d[4].push(c.blobs.to_string(a.epochAnonIdBlob)),d[4])})},function(a){return d[5]=c.i64.of_int32(d[4].length),c.i64.gt(d[5],c.i64.cast([0,0]))?c.sequence([function(a){return d[16]=c.i64.of_int32(d[4].length),c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2845]),c.i64.cast([0,2]),void 0,c.i64.to_string(d[16])):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[21]?d[22]=!0:d[22]=!1,d[22]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[24]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[24]].join("")),d[23]=c.createArray(),void 0!==void 0?d[25]=(d[23].push(void 0),d[23]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[24],d[23],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[4],c.i64.cast([0,0])).then(function(a){return a=a,d[17]=a[0],d[18]=a[1],a})},function(a){return d[19]=d[17],d[20]=c.i64.of_int32(d[4].length),c.i64.gt(d[20],c.i64.cast([0,0]))?c.loopAsync(d[20],function(a){return d[21]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[4],d[21]).then(function(a){return a=a,d[22]=a[0],d[23]=a[1],a})},function(a){return c.i64.eq([0,d[19].length],[0,d[22].length])?(d[19]===d[22]?d[25]=d[19]:(d[19]>d[22]?d[26]=d[19]:d[26]=d[22],d[25]=d[26]),d[24]=d[25]):(c.i64.gt([0,d[19].length],[0,d[22].length])?d[25]=d[19]:d[25]=d[22],d[24]=d[25]),d[19]=d[24]}])}):c.resolve()},function(a){return d[6]=d[19]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Epoch anon ID list is empty."),d[17]="Epoch anon ID list is empty.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",d[17]].join("")),d[16]=c.createArray(),void 0!==void 0?d[18]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",d[17],d[16],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2846]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[6]=void 0}])},function(a){return d[6]!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2863]),c.i64.cast([0,2]),void 0,d[6]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}]):c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2864]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[16]?d[17]=!0:d[17]=!1,d[17]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[19]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[19],d[18],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[12]=c.blobs.of_string(d[6]),c.blobs.neq(d[12],void 0)?c.sequence([function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2847]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.filter(c.db.table(169).fetch(),function(a){return c.blobs.eq(a.epochAnonIdBlob,d[12])}).next().then(function(a,e){var f=a.done;a=a.value;return f?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] Found a most recent epoch anon ID, but unable to locate it again in the table. This can really only happen if the tablesomehow changed in the middle of our transaction."),d[19]="Found a most recent epoch anon ID, but unable to locate it again in the table. This can really only happen if the tablesomehow changed in the middle of our transaction.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",d[19]].join("")),d[18]=c.createArray(),void 0!==void 0?d[20]=(d[18].push(void 0),d[18]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",d[19],d[18],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2848]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!0:d[21]=!1,d[21]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[23]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[23]].join("")),d[22]=c.createArray(),void 0!==void 0?d[24]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[23],d[22],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[16]=void 0}]):(e=a.item,c.sequence([function(a){return d[22]=e.epochAnonIdBlob,d[20]="Using latest epoch: ",d[21]=c.blobs.to_string(d[22]),d[18]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",d[18],d[20],d[18],d[21]].join("")),c.resolve()},function(a){return d[19]=new c.Map(),d[19].set("epoch_id",e.epochId),d[19].set("epoch_root_key",e.epochRootKeyBlob),d[19].set("epoch_anon_id",d[22]),d[16]=d[19]}]))})},function(a){return d[7]=d[16]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] No epochs whatsoever on client! This should absolutely never happen. Deleting backup from client."),d[17]="No epochs whatsoever on client! This should absolutely never happen. Deleting backup from client.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ","",d[17]].join("")),d[16]=c.createArray(),void 0!==void 0?d[18]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",d[17],d[16],c.i64.cast([0,3]))},function(a){return c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,2843]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[18]?d[19]=!0:d[19]=!1,d[19]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[21]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[21]].join("")),d[20]=c.createArray(),void 0!==void 0?d[22]=(d[20].push(void 0),d[20]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[21],d[20],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,"get_open_epoch_keys",!0,void 0,"Attempted to fetch epoch keys when there are no epochs on the client.",!1)},function(a){return d[7]=void 0}])},function(a){return d[8]=c.i64.of_float(Date.now()),d[9]=c.i64.random(),d[13]="Finishing execution. Execution time: ",d[14]=c.i64.to_string(c.i64.sub(d[8],d[0])),d[15]=" ms",d[10]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsGetOpenEpochKeysStoredProcedure] ",d[10],d[13],d[10],d[14],d[10],d[15]].join("")),c.i64.eq(c.i64.mod_(d[9],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[16]=",",d[17]=c.createArray(),void 0!==void 0?d[18]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGetOpenEpochKeysStoredProcedure",[d[13],d[16],d[14],d[16],d[15]].join(""),d[17],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[7]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGetOpenEpochKeysStoredProcedure";a.__tables__=["secure_encrypted_backups_epochs"];e.exports=a}),null);
__d("LSHandleCreateVirtualDeviceFailure",["LSAppendDataTraceAddon","LSDeleteBackupOnClient","LSFlushDataTrace.nop","LSIsMobileClient","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] Beginning execution."),c.sequence([function(d){return a[2]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),a[2],c.i64.cast([0,1412]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[7]=a[0],a})},function(a){return d[7]?d[8]=!0:d[8]=!1,d[8]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[10]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[10]].join("")),d[9]=c.createArray(),void 0!==void 0?d[11]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[10],d[9],c.i64.cast([0,3]))):c.resolve()}])},function(e){return a[1]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] Failure when creating virtual device, deleting backup"),d[8]="Failure when creating virtual device, deleting backup",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ","",d[8]].join("")),d[7]=c.createArray(),void 0!==void 0?d[9]=(d[7].push(void 0),d[7]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",d[8],d[7],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSDeleteBackupOnClient"),a[0],void 0,!1,a[2],void 0,!1)}]):c.sequence([function(e){return d[7]="Failure when creating virtual device",d[7]!==void 0?(function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ","",d[7]].join("")),d[8]=c.createArray(),a[2]!==void 0?d[9]=(d[8].push(a[2]),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",d[7],d[8],c.i64.cast([0,3]))):c.resolve()},function(a){return c.db.table(178).put({pk:c.i64.cast([0,1]),recoveryCodeStatus:c.i64.cast([0,3])})}])},function(e){return c.sequence([function(d){return a[2]!==void 0?c.nativeOperation(b("LSFlushDataTrace.nop"),a[2]):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[7]=a[0],a})},function(a){return d[7]?d[8]=!0:d[8]=!1,d[8]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[10]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[10]].join("")),d[9]=c.createArray(),void 0!==void 0?d[11]=(d[9].push(void 0),d[9]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[10],d[9],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[1]=c.i64.of_float(Date.now()),d[2]=c.i64.random(),d[4]="Finishing execution. Execution time: ",d[5]=c.i64.to_string(c.i64.sub(d[1],d[0])),d[6]=" ms",d[3]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure] ",d[3],d[4],d[3],d[5],d[3],d[6]].join("")),c.i64.eq(c.i64.mod_(d[2],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[7]=",",d[8]=c.createArray(),void 0!==void 0?d[9]=(d[8].push(void 0),d[8]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure",[d[4],d[7],d[5],d[7],d[6]].join(""),d[8],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleCreateVirtualDeviceFailureStoredProcedure";a.__tables__=["secure_encrypted_backups_recovery_code_status"];e.exports=a}),null);
__d("LSGenerateInitialVirtualDeviceSetupPayload",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSCreateEncryptionKeyPair.nop","LSCreateSignatureKeyPair.nop","LSCreateSignature_v2.nop","LSGetBlobFromString.nop","LSGetOpenEpochKeys","LSGetViewerFBID","LSHandleCreateVirtualDeviceFailure","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop","LSOcmfClientEvolve_v2.nop","LSParseRecoveryCode_v2.nop","LSSymmetricEncryptionCreateEncryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][generateInitialVirtualDeviceSetupPayload] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.db.table(174).fetch([[[c.i64.cast([0,1])]]]).next().then(function(e,f){var g=e.done;e=e.value;return g?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] No recovery code found in recovery code table"),d[12]="No recovery code found in recovery code table",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[12]].join("")),d[11]=c.createArray(),void 0!==void 0?d[14]=(d[11].push(void 0),d[11]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[12],d[11],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[13]=new c.Map(),d[13].set("error_code",c.i64.cast([0,501])),d[13].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[13].set("error_message",""),a=[void 0,d[13]],d[2]=a[0],d[3]=a[1],a}]):(f=e.item,c.sequence([function(a){return d[11]=c.createArray(),c.storedProcedure(b("LSGetViewerFBID")).then(function(a){return a=a,d[12]=a[0],a})},function(a){return c.nativeOperation(b("LSParseRecoveryCode_v2.nop"),f.recoveryCode,void 0==null?c.i64.to_string(d[12]):void 0,d[11]).then(function(a){return a=a,d[13]=a[0],d[14]=a[1],a})},function(e){return c.blobs.neq(d[14],void 0)?c.sequence([function(e){return c.blobs.neq(d[13],void 0)?c.sequence([function(a){return c.storedProcedure(b("LSGetOpenEpochKeys"),!0).then(function(a){return a=a,d[19]=a[0],a})},function(e){return d[19]!==void 0?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(b,e){var a=b.done;b=b.value;return a?(d[29]=new c.Map(),d[29].set("error_msg","Expected a nonempty query result"),d[29].set("code",c.i64.cast([0,3])),d[29].set("src_line","MEBClientStateUtils.php:244 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[30]=c.createArray(),d[31]=(d[30].push(d[29]),d[30]),a=[void 0,d[30]],d[22]=a[0],d[23]=a[1],a):(e=b.item,d[29]=new c.Map(),d[29].set("backup_id",e.backupId),d[29].set("device_public_key_blob",e.devicePublicKeyBlob),d[29].set("device_private_key_blob",e.devicePrivateKeyBlob),d[29].set("epoch_storage_public_key_blob",e.epochStoragePublicKeyBlob),d[29].set("epoch_storage_private_key_blob",e.epochStoragePrivateKeyBlob),d[29].set("epoch_auth_public_key_blob",e.epochAuthPublicKeyBlob),d[29].set("epoch_auth_private_key_blob",e.epochAuthPrivateKeyBlob),d[29].set("mailbox_root_key_blob",e.mailboxRootKeyBlob),d[29].set("ocmf_client_state_blob",e.ocmfClientStateBlob),d[29].set("orf_client_state_v2_blob",void 0),d[29].set("orf_v2_authority_level",void 0),d[29].set("oblivious_validation_token_blob",e.obliviousValidationTokenBlob),d[29].set("device_id",e.deviceId),d[29].set("backup_tenancy",e.backupTenancy),d[29].set("encryption_version",e.encryptionVersion),d[29].set("revision_version",e.revisionVersion),d[29].set("initialize_restore_result",void 0),d[29].set("authority_level",e.authorityLevel),a=[d[29],void 0],d[22]=a[0],d[23]=a[1],a)})},function(a){return d[25]=new c.Map(),d[25].set("value",d[22]),d[25].set("errors",d[23]),d[26]=d[25].get("value"),d[26]!==void 0?c.sequence([function(a){return d[29]=d[26].get("backup_id"),d[30]=d[26].get("device_public_key_blob"),d[31]=d[26].get("device_private_key_blob"),d[32]=d[26].get("epoch_storage_public_key_blob"),d[33]=d[26].get("epoch_storage_private_key_blob"),d[34]=d[26].get("epoch_auth_public_key_blob"),d[35]=d[26].get("epoch_auth_private_key_blob"),d[36]=d[26].get("mailbox_root_key_blob"),d[37]=d[26].get("ocmf_client_state_blob"),d[38]=d[26].get("orf_client_state_v2_blob"),d[39]=d[26].get("orf_v2_authority_level"),d[40]=d[26].get("oblivious_validation_token_blob"),d[41]=d[26].get("device_id"),d[42]=d[26].get("backup_tenancy"),d[43]=d[26].get("encryption_version"),d[44]=d[26].get("revision_version"),d[45]=d[26].get("initialize_restore_result"),d[46]=d[26].get("authority_level"),c.i64.neq(d[41],void 0)?c.sequence([function(a){return d[49]=void 0,c.i64.neq(d[49],void 0)?c.resolve(d[50]=d[49]):c.sequence([function(a){return d[101]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[102]=a[0],a})},function(a){return d[102]?d[111]=(d[101].push(c.i64.cast([0,0])),d[101]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[103]=a[0],a})},function(a){return d[103]?d[111]=(d[101].push(c.i64.cast([0,2])),d[101]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[104]=a[0],a})},function(a){return d[104]?d[111]=(d[101].push(c.i64.cast([0,3])),d[101]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[105]=a[0],a})},function(a){return d[105]?d[111]=(d[101].push(c.i64.cast([0,4])),d[101]):0,d[106]=c.createArray(),d[107]=c.i64.of_int32(d[101].length),c.i64.gt(d[107],c.i64.cast([0,0]))?c.loopAsync(d[107],function(a){return d[111]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[101],d[111]).then(function(a){return a=a,d[112]=a[0],d[113]=a[1],a})},function(a){return d[114]=(d[106].push(d[112]),d[106])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[111]=c.createArray(),d[112]=c.i64.of_int32(d[106].length),c.i64.gt(d[112],c.i64.cast([0,0]))?c.loopAsync(d[112],function(a){return d[114]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[106],d[114]).then(function(a){return a=a,d[115]=a[0],d[116]=a[1],a})},function(a){return d[117]=(d[111].push(c.i64.to_string(d[115])),d[111])}])}):c.resolve()},function(a){return d[113]=d[111].join(","),d[108]=d[113]}])},function(a){return d[106].some(function(a){return c.i64.eq(d[43],a)})?d[109]=d[43]:d[109]=void 0,c.i64.neq(d[109],void 0)?d[110]=d[109]:d[110]=void 0,d[50]=d[110]}])},function(a){return c.i64.neq(d[50],void 0)?d[51]=d[50]:d[51]=c.i64.cast([0,0]),c.i64.neq(d[42],void 0)?d[52]=d[42]:d[52]=c.i64.cast([0,1]),c.nativeOperation(b("LSCreateSignatureKeyPair.nop")).then(function(a){return a=a,d[53]=a[0],d[54]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateEncryptionKeyPair.nop")).then(function(a){return a=a,d[55]=a[0],d[56]=a[1],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[53],c.blob("MA=="),d[56]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[58]=d[19].get("epoch_anon_id"),d[59]=d[19].get("epoch_root_key"),d[60]=c.createArray(),d[101]=(d[60].push(c.i64.cast([0,32])),d[60]),c.nativeOperation(b("LSBase64Encode.nop"),d[58]).then(function(a){return a=a,d[61]=a[0],a})},function(a){return d[61]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blobs.of_string(["epoch_devices","_",d[61]].join("")),void 0,d[59],d[60]).then(function(a){return a=a,d[101]=a[0],a})},function(a){return d[101]?d[102]=!1:d[102]=!0,d[102]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),d[105]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[105]].join("")),d[104]=c.createArray(),void 0!==void 0?d[107]=(d[104].push(void 0),d[104]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[105],d[104],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[106]=a[0],a})},function(a){return d[103]=d[106]}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[101],c.i64.cast([0,0])).then(function(a){return a=a,d[104]=a[0],d[105]=a[1],a})},function(a){return d[103]=d[104]}])},function(a){return d[62]=d[103]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),d[102]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[104]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[102],d[101],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[103]=a[0],a})},function(a){return d[62]=d[103]}])},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),d[62],d[54]).then(function(a){return a=a,d[63]=a[0],a})},function(a){return c.blobs.neq(d[63],void 0)?c.resolve(d[64]=d[63]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] device_epoch_hmac is null!"),d[102]="device_epoch_hmac is null!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[104]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[103]=a[0],a})},function(a){return d[64]=d[103]}])},function(a){return d[65]=d[19].get("epoch_root_key"),d[66]=c.createArray(),d[101]=(d[66].push(c.i64.cast([0,18])),d[66]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[65],d[66]).then(function(a){return a=a,d[67]=a[0],a})},function(a){return d[67]!==void 0?c.sequence([function(a){return d[101]=c.i64.of_int32(d[67].length),c.i64.ge(d[101],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[67],c.i64.cast([0,0])).then(function(a){return a=a,d[103]=a[0],d[104]=a[1],a})},function(a){return d[102]=d[103]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[104]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[104]].join("")),d[103]=c.createArray(),void 0!==void 0?d[105]=(d[103].push(void 0),d[103]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[104],d[103],c.i64.cast([0,3]))},function(a){return d[102]=void 0}])},function(a){return d[68]=d[102]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[102]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[102],d[101],c.i64.cast([0,3]))},function(a){return d[68]=void 0}])},function(a){return c.blobs.neq(d[68],void 0)?d[69]=!0:d[69]=!1,d[69]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),d[37]).then(function(a){return a=a,d[70]=a[0],d[71]=a[1],a})},function(a){return c.blobs.neq(void 0,void 0)?c.sequence([function(a){return c.nativeOperation(b("LSOcmfClientEvolve_v2.nop"),void 0).then(function(a){return a=a,d[101]=a[0],d[102]=a[1],a})},function(a){return a=[d[70],d[71],d[101],d[102]],d[72]=a[0],d[73]=a[1],d[74]=a[2],d[75]=a[3],a}]):c.resolve((a=[d[70],d[71],void 0,void 0],d[72]=a[0],d[73]=a[1],d[74]=a[2],d[75]=a[3],a))},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[53]).then(function(a){return a=a,d[76]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[14],c.blob("dmlydHVhbF9kZXZpY2U6dmlydHVhbF9kZXZpY2VfcHJpdmF0ZV9rZXk="),d[76]==null?"":d[76]).then(function(a){return a=a,d[77]=a[0],a})},function(a){return d[77]!==void 0?d[78]=d[77]:d[78]="",d[78]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_device_private_key is empty!"),d[102]="encrypted_device_private_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[55]).then(function(a){return a=a,d[79]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[14],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfc3RvcmFnZV9wcml2YXRlX2tleQ=="),d[79]==null?"":d[79]).then(function(a){return a=a,d[80]=a[0],a})},function(a){return d[80]!==void 0?d[81]=d[80]:d[81]="",d[81]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_storage_private_key is empty!"),d[102]="encrypted_epoch_storage_private_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[72]).then(function(a){return a=a,d[82]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[14],c.blob("dmlydHVhbF9kZXZpY2U6b2NtZl9jbGllbnRfc3RhdGU="),d[82]==null?"":d[82]).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[83]!==void 0?d[84]=d[83]:d[84]="",d[84]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_orf_client_state_v1_shape is empty!"),d[102]="encrypted_orf_client_state_v1_shape is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[40]).then(function(a){return a=a,d[85]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[14],c.blob("dmlydHVhbF9kZXZpY2U6b2JsaXZpb3VzX3ZhbGlkYXRpb25fdG9rZW4="),d[85]==null?"":d[85]).then(function(a){return a=a,d[86]=a[0],a})},function(a){return d[86]!==void 0?d[87]=d[86]:d[87]="",d[87]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_oblivious_validation_token is empty!"),d[102]="encrypted_oblivious_validation_token is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))):c.resolve()},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[36]).then(function(a){return a=a,d[88]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[14],c.blob("dmlydHVhbF9kZXZpY2U6bWFpbGJveF9yb290X2tleQ=="),d[88]==null?"":d[88]).then(function(a){return a=a,d[89]=a[0],a})},function(a){return d[89]!==void 0?d[90]=d[89]:d[90]="",d[90]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_mailbox_root_key is empty!"),d[102]="encrypted_mailbox_root_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))):c.resolve()},function(a){return d[91]=d[19].get("epoch_anon_id"),c.nativeOperation(b("LSBase64Encode.nop"),d[91]).then(function(a){return a=a,d[92]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[14],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfYW5vbl9pZA=="),d[92]==null?"":d[92]).then(function(a){return a=a,d[93]=a[0],a})},function(a){return d[93]!==void 0?d[94]=d[93]:d[94]="",d[94]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_anon_id is empty!"),d[102]="encrypted_epoch_anon_id is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))):c.resolve()},function(a){return d[95]=d[19].get("epoch_root_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[95]).then(function(a){return a=a,d[96]=a[0],a})},function(a){return c.nativeOperation(b("LSSymmetricEncryptionCreateEncryptedString.nop"),d[14],c.blob("dmlydHVhbF9kZXZpY2U6ZXBvY2hfcm9vdF9rZXk="),d[96]==null?"":d[96]).then(function(a){return a=a,d[97]=a[0],a})},function(a){return d[97]!==void 0?d[98]=d[97]:d[98]="",d[98]===""?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] encrypted_epoch_root_key is empty!"),d[102]="encrypted_epoch_root_key is empty!",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[102]].join("")),d[101]=c.createArray(),void 0!==void 0?d[103]=(d[101].push(void 0),d[101]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[102],d[101],c.i64.cast([0,3]))):c.resolve()},function(a){return d[99]=new c.Map(),d[99].set("encrypted_device_private_key",d[78]),d[99].set("encrypted_epoch_storage_private_key",d[81]),d[99].set("encrypted_ocmf_client_state",d[84]),d[99].set("encrypted_orf_client_state_v2",void 0),d[99].set("encrypted_oblivious_validation_token_blob",d[87]),d[99].set("encrypted_mailbox_root_key_blob",d[90]),d[99].set("encrypted_epoch_anon_id",d[94]),d[99].set("encrypted_epoch_root_key",d[98]),d[100]=new c.Map(),d[100].set("virtual_device_public_key",d[54]),d[100].set("virtual_device_id",d[13]),d[100].set("virtual_device_epoch_storage_public_key",d[56]),d[100].set("virtual_device_epoch_storage_public_key_sig",d[57]==null?c.blob("bnVsbA=="):d[57]),d[100].set("device_epoch_hmac",d[64]),d[100].set("epoch_root_key_fingerprint",d[68]),d[100].set("virtual_device_type",f.virtualDeviceType),d[100].set("action_type",c.i64.cast([0,1])),d[100].set("ocmf_rotation_token",d[73]),d[100].set("encrypted_secret_values_payload",d[99]),d[100].set("cloud_service_account",f.cloudServiceAccount),d[100].set("hsm_pin_normalization_status",f.hsmPinNormalizationStatus),d[100].set("security_question_type",void 0),d[100].set("trusted_contact_id",void 0),a=[d[100],void 0],d[47]=a[0],d[48]=a[1],a}]):c.resolve((d[49]=new c.Map(),d[49].set("error_code",c.i64.cast([0,9])),d[49].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[49].set("error_message",""),a=[void 0,d[49]],d[47]=a[0],d[48]=a[1],a))},function(a){return a=[d[47],d[48]],d[27]=a[0],d[28]=a[1],a}]):c.resolve((d[29]=d[25].get("errors"),d[30]=d[25].get("errors"),d[31]=new c.Map(),d[31].set("error_code",c.i64.cast([0,9])),d[31].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[31].set("error_message",""),a=[void 0,d[31]],d[27]=a[0],d[28]=a[1],a))},function(a){return a=[d[27],d[28]],d[20]=a[0],d[21]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Epoch keys are unavailable."),d[23]="Epoch keys are unavailable.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[23]].join("")),d[22]=c.createArray(),void 0!==void 0?d[25]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[23],d[22],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[24]=new c.Map(),d[24].set("error_code",c.i64.cast([0,11])),d[24].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[24].set("error_message",""),a=[void 0,d[24]],d[20]=a[0],d[21]=a[1],a}])},function(a){return a=[d[20],d[21]],d[17]=a[0],d[18]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),d[20]="Invalid Recovery Code Provided",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[20]].join("")),d[19]=c.createArray(),void 0!==void 0?d[22]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[20],d[19],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[21]=new c.Map(),d[21].set("error_code",c.i64.cast([0,10])),d[21].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[21].set("error_message",""),a=[void 0,d[21]],d[17]=a[0],d[18]=a[1],a}])},function(a){return a=[d[17],d[18]],d[15]=a[0],d[16]=a[1],a}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] Invalid Recovery Code Provided"),d[18]="Invalid Recovery Code Provided",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure] ","",d[18]].join("")),d[17]=c.createArray(),void 0!==void 0?d[20]=(d[17].push(void 0),d[17]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure",d[18],d[17],c.i64.cast([0,3]))},function(d){return c.storedProcedure(b("LSHandleCreateVirtualDeviceFailure"),a[0],!0,void 0)},function(a){return d[19]=new c.Map(),d[19].set("error_code",c.i64.cast([0,10])),d[19].set("stored_procedure","LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure"),d[19].set("error_message",""),a=[void 0,d[19]],d[15]=a[0],d[16]=a[1],a}])},function(a){return a=[d[15],d[16]],d[2]=a[0],d[3]=a[1],a}]))})},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][generateInitialVirtualDeviceSetupPayload] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"generateInitialVirtualDeviceSetupPayload",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[2],d[3]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsGenerateInitialVirtualDeviceSetupPayloadStoredProcedure";a.__tables__=["secure_encrypted_backups_generated_recovery_code","secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSInitializeBackupV2",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSCreateMinosEpochParams.nop","LSCreateSignature_v2.nop","LSGenerateInitialDeviceSetupPayload","LSGenerateInitialEpochSetupPayload","LSGenerateInitialVirtualDeviceSetupPayload","LSGetBlobFromString.nop","LSHmac_v2.nop","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][initializeBackupV2] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.storedProcedure(b("LSGenerateInitialDeviceSetupPayload"),a[0]).then(function(a){return a=a,d[2]=a[0],d[3]=a[1],a})},function(e){return d[2]!==void 0?c.sequence([function(a){return d[15]=d[2].get("device_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[15]).then(function(a){return a=a,d[16]=a[0],a})},function(a){return d[17]=d[2].get("epoch_storage_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[17]).then(function(a){return a=a,d[18]=a[0],a})},function(a){return d[19]=d[2].get("epoch_storage_public_key_sig"),c.nativeOperation(b("LSBase64Encode.nop"),d[19]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[21]=d[2].get("epoch_auth_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[21]).then(function(a){return a=a,d[22]=a[0],a})},function(a){return d[23]=d[2].get("epoch_auth_public_key_sig"),c.nativeOperation(b("LSBase64Encode.nop"),d[23]).then(function(a){return a=a,d[24]=a[0],a})},function(a){return d[25]=d[2].get("ocmf_client_state"),c.nativeOperation(b("LSBase64Encode.nop"),d[25]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[27]=d[2].get("mailbox_root_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[27]).then(function(a){return a=a,d[28]=a[0],a})},function(a){return d[29]=d[2].get("device_private_key"),d[30]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[31]?d[44]=(d[30].push(c.i64.cast([0,0])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[32]=a[0],a})},function(a){return d[32]?d[44]=(d[30].push(c.i64.cast([0,2])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[33]=a[0],a})},function(a){return d[33]?d[44]=(d[30].push(c.i64.cast([0,3])),d[30]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[34]=a[0],a})},function(a){return d[34]?d[44]=(d[30].push(c.i64.cast([0,4])),d[30]):0,d[35]="",d[36]=c.i64.of_int32(d[30].length),c.i64.gt(d[36],c.i64.cast([0,0]))?c.loopAsync(d[36],function(a){return d[44]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[30],d[44]).then(function(a){return a=a,d[45]=a[0],d[46]=a[1],a})},function(a){return d[35]=[d[35],"_",c.i64.to_string(d[45])].join("")}])}):c.resolve()},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),["supported_versions_",d[35],"revision_version_",c.i64.to_string(c.i64.cast([0,1]))].join("")).then(function(a){return a=a,d[37]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateSignature_v2.nop"),d[29],c.blob("Mg=="),d[37]).then(function(a){return a=a,d[38]=a[0],a})},function(a){return c.blobs.neq(d[38],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[38]).then(function(a){return a=a,d[44]=a[0],a})},function(a){return d[39]=d[44]}]):c.resolve(d[39]=void 0)},function(b){return d[40]=d[2].get("optimistic_backup_id"),d[41]=d[2].get("mailbox_partial_id"),d[42]=new c.Map(),d[42].set("supported_encryption_versions",d[30]),d[42].set("client_version",c.i64.cast([0,1])),d[42].set("version_sig",d[39]==null?"":d[39]),d[43]=new c.Map(),d[43].set("device_public_key",d[16]==null?"":d[16]),d[43].set("epoch_storage_public_key",d[18]==null?"":d[18]),d[43].set("epoch_storage_public_key_sig",d[20]==null?"":d[20]),d[43].set("epoch_auth_public_key",d[22]==null?"":d[22]),d[43].set("epoch_auth_public_key_sig",d[24]==null?"":d[24]),d[43].set("device_registration_id",a[0]),d[43].set("ocmf_client_state",d[26]==null?"":d[26]),d[43].set("mailbox_partial_id",d[41]),d[43].set("mailbox_root_key",d[28]==null?"":d[28]),d[43].set("encryption_version_data",d[42]),b=[d[43],d[40],!0,c.i64.cast([0,0])],d[4]=b[0],d[5]=b[1],d[6]=b[2],d[7]=b[3],b}]):c.resolve((d[3]!==void 0?(d[19]=d[3].get("error_code"),e=[void 0,c.i64.cast([-1,4294967295]),!1,d[19]],d[15]=e[0],d[16]=e[1],d[17]=e[2],d[18]=e[3],e):(e=[void 0,c.i64.cast([-1,4294967295]),!1,c.i64.cast([0,12])],d[15]=e[0],d[16]=e[1],d[17]=e[2],d[18]=e[3],e),e=[d[15],d[16],d[17],d[18]],d[4]=e[0],d[5]=e[1],d[6]=e[2],d[7]=e[3],e))},function(e){return d[6]?c.sequence([function(e){return d[4]!==void 0?c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!0}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,b){var e=a.done;a=a.value;return e?(d[25]=new c.Map(),d[25].set("error_msg","Expected a nonempty query result"),d[25].set("code",c.i64.cast([0,3])),d[25].set("src_line","MEBClientStateUtils.php:244 MEBClientStateUtils::maybeClientStateFromDatabaseDirectly()"),d[26]=c.createArray(),d[27]=(d[26].push(d[25]),d[26]),e=[void 0,d[26]],d[16]=e[0],d[17]=e[1],e):(b=a.item,d[25]=new c.Map(),d[25].set("backup_id",b.backupId),d[25].set("device_public_key_blob",b.devicePublicKeyBlob),d[25].set("device_private_key_blob",b.devicePrivateKeyBlob),d[25].set("epoch_storage_public_key_blob",b.epochStoragePublicKeyBlob),d[25].set("epoch_storage_private_key_blob",b.epochStoragePrivateKeyBlob),d[25].set("epoch_auth_public_key_blob",b.epochAuthPublicKeyBlob),d[25].set("epoch_auth_private_key_blob",b.epochAuthPrivateKeyBlob),d[25].set("mailbox_root_key_blob",b.mailboxRootKeyBlob),d[25].set("ocmf_client_state_blob",b.ocmfClientStateBlob),d[25].set("orf_client_state_v2_blob",void 0),d[25].set("orf_v2_authority_level",void 0),d[25].set("oblivious_validation_token_blob",b.obliviousValidationTokenBlob),d[25].set("device_id",b.deviceId),d[25].set("backup_tenancy",b.backupTenancy),d[25].set("encryption_version",b.encryptionVersion),d[25].set("revision_version",b.revisionVersion),d[25].set("initialize_restore_result",void 0),d[25].set("authority_level",b.authorityLevel),e=[d[25],void 0],d[16]=e[0],d[17]=e[1],e)})},function(a){return d[19]=new c.Map(),d[19].set("value",d[16]),d[19].set("errors",d[17]),d[20]=d[19].get("value"),d[20]!==void 0?c.sequence([function(a){return d[25]=d[20].get("backup_id"),d[26]=d[20].get("device_public_key_blob"),d[27]=d[20].get("device_private_key_blob"),d[28]=d[20].get("epoch_storage_public_key_blob"),d[29]=d[20].get("epoch_storage_private_key_blob"),d[30]=d[20].get("epoch_auth_public_key_blob"),d[31]=d[20].get("epoch_auth_private_key_blob"),d[32]=d[20].get("mailbox_root_key_blob"),d[33]=d[20].get("ocmf_client_state_blob"),d[34]=d[20].get("orf_client_state_v2_blob"),d[35]=d[20].get("orf_v2_authority_level"),d[36]=d[20].get("oblivious_validation_token_blob"),d[37]=d[20].get("device_id"),d[38]=d[20].get("backup_tenancy"),d[39]=d[20].get("encryption_version"),d[40]=d[20].get("revision_version"),d[41]=d[20].get("initialize_restore_result"),d[42]=d[20].get("authority_level"),c.i64.neq(d[37],void 0)?c.sequence([function(a){return d[46]=void 0,c.i64.neq(d[46],void 0)?c.resolve(d[47]=d[46]):c.sequence([function(a){return d[57]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[58]=a[0],a})},function(a){return d[58]?d[67]=(d[57].push(c.i64.cast([0,0])),d[57]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[59]=a[0],a})},function(a){return d[59]?d[67]=(d[57].push(c.i64.cast([0,2])),d[57]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[60]=a[0],a})},function(a){return d[60]?d[67]=(d[57].push(c.i64.cast([0,3])),d[57]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[61]=a[0],a})},function(a){return d[61]?d[67]=(d[57].push(c.i64.cast([0,4])),d[57]):0,d[62]=c.createArray(),d[63]=c.i64.of_int32(d[57].length),c.i64.gt(d[63],c.i64.cast([0,0]))?c.loopAsync(d[63],function(a){return d[67]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[57],d[67]).then(function(a){return a=a,d[68]=a[0],d[69]=a[1],a})},function(a){return d[70]=(d[62].push(d[68]),d[62])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[67]=c.createArray(),d[68]=c.i64.of_int32(d[62].length),c.i64.gt(d[68],c.i64.cast([0,0]))?c.loopAsync(d[68],function(a){return d[70]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[62],d[70]).then(function(a){return a=a,d[71]=a[0],d[72]=a[1],a})},function(a){return d[73]=(d[67].push(c.i64.to_string(d[71])),d[67])}])}):c.resolve()},function(a){return d[69]=d[67].join(","),d[64]=d[69]}])},function(a){return d[62].some(function(a){return c.i64.eq(d[39],a)})?d[65]=d[39]:d[65]=void 0,c.i64.neq(d[65],void 0)?d[66]=d[65]:d[66]=void 0,d[47]=d[66]}])},function(a){return c.i64.neq(d[47],void 0)?d[48]=d[47]:d[48]=c.i64.cast([0,0]),c.i64.neq(d[38],void 0)?d[49]=d[38]:d[49]=c.i64.cast([0,1]),d[50]=new c.Map(),d[50].set("device_id",d[37]),d[50].set("public_key",d[26]),d[51]=c.createArray(),d[57]=(d[51].push(d[50]),d[51]),c.storedProcedure(b("LSGenerateInitialEpochSetupPayload"),d[25],d[51]).then(function(a){return a=a,d[52]=a[0],d[53]=a[1],a})},function(a){return d[52]!==void 0?c.sequence([function(a){return d[57]=d[52].get("epoch_anon_id"),d[58]=d[52].get("epoch_root_key"),c.blobs.neq(d[58],void 0)?c.sequence([function(a){return d[75]=c.createArray(),d[81]=(d[75].push(c.i64.cast([0,18])),d[75]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[58],d[75]).then(function(a){return a=a,d[76]=a[0],a})},function(a){return d[76]!==void 0?c.sequence([function(a){return d[81]=c.i64.of_int32(d[76].length),c.i64.ge(d[81],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[76],c.i64.cast([0,0])).then(function(a){return a=a,d[83]=a[0],d[84]=a[1],a})},function(a){return d[82]=d[83]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[84]="CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[84]].join("")),d[83]=c.createArray(),void 0!==void 0?d[85]=(d[83].push(void 0),d[83]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[84],d[83],c.i64.cast([0,3]))},function(a){return d[82]=void 0}])},function(a){return d[77]=d[82]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[82]="CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBFingerprint] ","",d[82]].join("")),d[81]=c.createArray(),void 0!==void 0?d[83]=(d[81].push(void 0),d[81]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint",d[82],d[81],c.i64.cast([0,3]))},function(a){return d[77]=void 0}])},function(a){return c.blobs.neq(d[77],void 0)?d[78]=!0:d[78]=!1,d[78]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.nativeOperation(b("LSBase64Encode.nop"),d[77]).then(function(a){return a=a,d[79]=a[0],a})},function(a){return d[79]!==void 0?d[80]=d[79]:d[80]="encodingfailed",d[59]=d[80]}]):c.resolve(d[59]="null")},function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[51],c.i64.cast([0,0])).then(function(a){return a=a,d[60]=a[0],d[61]=a[1],a})},function(a){return d[62]=d[60].get("public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[62]).then(function(a){return a=a,d[63]=a[0],a})},function(a){return d[64]=d[60].get("public_key"),d[65]=c.createArray(),d[75]=(d[65].push(c.i64.cast([0,32])),d[65]),c.nativeOperation(b("LSBase64Encode.nop"),d[57]).then(function(a){return a=a,d[66]=a[0],a})},function(a){return d[66]!==void 0?c.sequence([function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blobs.of_string(["epoch_devices","_",d[66]].join("")),void 0,d[58],d[65]).then(function(a){return a=a,d[75]=a[0],a})},function(a){return d[75]?d[76]=!1:d[76]=!0,d[76]?c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish"),d[79]="THIS IS NOT EXPECTED. Found null keys while deriving keys for epoch. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[79]].join("")),d[78]=c.createArray(),void 0!==void 0?d[81]=(d[78].push(void 0),d[78]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[79],d[78],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[80]=a[0],a})},function(a){return d[77]=d[80]}]):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[75],c.i64.cast([0,0])).then(function(a){return a=a,d[78]=a[0],d[79]=a[1],a})},function(a){return d[77]=d[78]}])},function(a){return d[67]=d[77]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBCryptoEpochUtils] THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish"),d[76]="THIS IS NOT EXPECTED. Failed to base64 encode epoch anon id. Returning empty blobish",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBCryptoEpochUtils] ","",d[76]].join("")),d[75]=c.createArray(),void 0!==void 0?d[78]=(d[75].push(void 0),d[75]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBCryptoEpochUtils",d[76],d[75],c.i64.cast([0,3]))},function(a){return c.nativeOperation(b("LSGetBlobFromString.nop"),"").then(function(a){return a=a,d[77]=a[0],a})},function(a){return d[67]=d[77]}])},function(a){return c.nativeOperation(b("LSHmac_v2.nop"),d[67],d[64]).then(function(a){return a=a,d[68]=a[0],a})},function(a){return c.sequence([function(a){return c.nativeOperation(b("LSCreateMinosEpochParams.nop"),d[58],d[57],void 0,void 0,void 0).then(function(a){return a=a,d[75]=a[0],d[76]=a[1],d[77]=a[2],d[78]=a[3],d[79]=a[4],d[80]=a[5],a})},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[75]).then(function(a){return a=a,d[81]=a[0],a})},function(a){return d[81]!==void 0?d[82]=d[81]:d[82]="",c.nativeOperation(b("LSBase64Encode.nop"),d[77]).then(function(a){return a=a,d[83]=a[0],a})},function(a){return d[83]!==void 0?d[84]=d[83]:d[84]="",c.nativeOperation(b("LSBase64Encode.nop"),d[76]).then(function(a){return a=a,d[85]=a[0],a})},function(a){return d[85]!==void 0?d[86]=d[85]:d[86]="",c.nativeOperation(b("LSBase64Encode.nop"),d[78]).then(function(a){return a=a,d[87]=a[0],a})},function(a){return d[87]!==void 0?d[88]=d[87]:d[88]="",c.blobs.neq(void 0,void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),void 0).then(function(a){return a=a,d[95]=a[0],a})},function(a){return d[95]!==void 0?d[96]=d[95]:d[96]="",d[89]=d[96]}]):c.resolve(d[89]=void 0)},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[79]).then(function(a){return a=a,d[90]=a[0],a})},function(a){return d[90]!==void 0?d[91]=d[90]:d[91]="",c.blobs.neq(d[80],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[80]).then(function(a){return a=a,d[95]=a[0],a})},function(a){return d[95]!==void 0?d[96]=d[95]:d[96]="",d[92]=d[96]}]):c.resolve(d[92]=void 0)},function(a){return d[93]=new c.Map(),d[93].set("mailbox_encryption_public_key",d[82]),d[93].set("mailbox_auth_public_key",d[84]),d[93].set("mailbox_signing_public_key",d[86]),d[93].set("epoch_head",d[88]),d[93].set("previous_epoch_head",d[89]),d[93].set("self_signature",d[91]),d[93].set("prev_signature",d[92]),d[93]!==void 0?c.resolve(d[94]=d[93]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBEpochUtils] Missing Native Op for MEBMinosCreateMailboxEncryptionKeyPair"),d[96]="Missing Native Op for MEBMinosCreateMailboxEncryptionKeyPair",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBEpochUtils] ","",d[96]].join("")),d[95]=c.createArray(),void 0!==void 0?d[97]=(d[95].push(void 0),d[95]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBEpochUtils",d[96],d[95],c.i64.cast([0,3]))},function(a){return d[94]=void 0}])},function(a){return d[69]=d[94]}])},function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[57]).then(function(a){return a=a,d[70]=a[0],a})},function(a){return d[71]=d[52].get("optimistic_epoch_id"),c.blobs.neq(d[68],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[68]).then(function(a){return a=a,d[75]=a[0],a})},function(a){return d[72]=d[75]}]):c.resolve(d[72]=void 0)},function(a){return d[73]=new c.Map(),d[73].set("device_pub",d[63]==null?"":d[63]),d[73].set("hmac",d[72]==null?"":d[72]),d[73].set("encrypted_epoch_key",void 0),d[73].set("epoch_root_key_fingerprint",d[59]),d[74]=new c.Map(),d[74].set("epoch_data",""),d[74].set("epoch_anon_id",d[70]==null?"":d[70]),d[74].set("minos_epoch_creation_params",d[69]),d[74].set("optimistic_epoch_id",d[71]),d[74].set("membership",d[73]),a=[d[74],!0,c.i64.cast([0,0])],d[54]=a[0],d[55]=a[1],d[56]=a[2],a}]):c.resolve((d[53]!==void 0?(d[60]=d[53].get("error_code"),a=[void 0,!1,d[60]],d[57]=a[0],d[58]=a[1],d[59]=a[2],a):(a=[void 0,!1,c.i64.cast([0,14])],d[57]=a[0],d[58]=a[1],d[59]=a[2],a),a=[d[57],d[58],d[59]],d[54]=a[0],d[55]=a[1],d[56]=a[2],a))},function(a){return a=[d[54],d[55],d[56]],d[43]=a[0],d[44]=a[1],d[45]=a[2],a}]):c.resolve((a=[void 0,!1,c.i64.cast([0,9])],d[43]=a[0],d[44]=a[1],d[45]=a[2],a))},function(a){return a=[d[43],d[44],d[45]],d[21]=a[0],d[22]=a[1],d[23]=a[2],a}]):c.resolve((d[25]=d[19].get("errors"),d[26]=d[19].get("errors"),a=[void 0,!1,c.i64.cast([0,9])],d[21]=a[0],d[22]=a[1],d[23]=a[2],a))},function(e){return d[22]?c.sequence([function(e){return d[21]!==void 0?c.sequence([function(a){return c.storedProcedure(b("LSGenerateInitialVirtualDeviceSetupPayload"),d[5]).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return d[26]!==void 0?c.sequence([function(a){return d[32]=d[26].get("virtual_device_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[32]).then(function(a){return a=a,d[33]=a[0],a})},function(a){return d[34]=d[26].get("virtual_device_id"),c.nativeOperation(b("LSBase64Encode.nop"),d[34]).then(function(a){return a=a,d[35]=a[0],a})},function(a){return d[36]=d[26].get("virtual_device_epoch_storage_public_key"),c.nativeOperation(b("LSBase64Encode.nop"),d[36]).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[38]=d[26].get("virtual_device_epoch_storage_public_key_sig"),c.nativeOperation(b("LSBase64Encode.nop"),d[38]).then(function(a){return a=a,d[39]=a[0],a})},function(a){return d[40]=d[26].get("device_epoch_hmac"),c.nativeOperation(b("LSBase64Encode.nop"),d[40]).then(function(a){return a=a,d[41]=a[0],a})},function(a){return d[42]=d[26].get("epoch_root_key_fingerprint"),c.blobs.neq(d[42],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[42]).then(function(a){return a=a,d[54]=a[0],a})},function(a){return d[43]=d[54]}]):c.resolve(d[43]=void 0)},function(a){return d[44]=d[26].get("ocmf_rotation_token"),c.nativeOperation(b("LSBase64Encode.nop"),d[44]).then(function(a){return a=a,d[45]=a[0],a})},function(a){return d[46]=d[26].get("encrypted_secret_values_payload"),d[47]=d[26].get("virtual_device_type"),d[48]=d[26].get("action_type"),d[49]=d[26].get("cloud_service_account"),d[50]=d[26].get("hsm_pin_normalization_status"),d[51]=d[26].get("security_question_type"),d[52]=d[26].get("trusted_contact_id"),d[53]=new c.Map(),d[53].set("virtual_device_public_key",d[33]==null?"":d[33]),d[53].set("virtual_device_id",d[35]==null?"":d[35]),d[53].set("virtual_device_epoch_storage_public_key",d[37]==null?"":d[37]),d[53].set("virtual_device_epoch_storage_public_key_sig",d[39]==null?"":d[39]),d[53].set("encrypted_secret_values",d[46]),d[53].set("device_epoch_hmac",d[41]==null?"":d[41]),d[53].set("epoch_root_key_fingerprint",d[43]),d[53].set("ocmf_rotation_token",d[45]==null?"":d[45]),d[53].set("virtual_device_type",d[47]),d[53].set("action_type",d[48]),d[53].set("cloud_service_account",d[49]),d[53].set("hsm_pin_normalization_status",d[50]),d[53].set("security_question_type",d[51]),d[53].set("trusted_contact_id",d[52]),a=[d[53],!0,c.i64.cast([0,0])],d[28]=a[0],d[29]=a[1],d[30]=a[2],a}]):c.resolve((d[27]!==void 0?(d[35]=d[27].get("error_code"),a=[void 0,!1,d[35]],d[32]=a[0],d[33]=a[1],d[34]=a[2],a):(a=[void 0,!1,c.i64.cast([0,16])],d[32]=a[0],d[33]=a[1],d[34]=a[2],a),a=[d[32],d[33],d[34]],d[28]=a[0],d[29]=a[1],d[30]=a[2],a))},function(e){return d[29]?c.sequence([function(e){return d[28]!==void 0?c.sequence([function(e){return d[33]=new c.Map(),d[33].set("optimistic_backup_id",d[5]),d[33].set("device_payload",d[4]),d[33].set("epoch_payload",d[21]),d[33].set("virtual_device_payload",d[28]),d[38]=c.i64.cast([0,1e3]),d[34]=d[38],d[35]=new c.Map(),d[35].set("success",d[33]),d[35].set("request_id",a[1]),d[36]=c.toJSON(d[35]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50033]),d[36],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,d[34]).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[32]=c.i64.cast([0,0])}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null virtual device payload"),d[34]="Null virtual device payload",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",d[34]].join("")),d[33]=c.createArray(),void 0!==void 0?d[39]=(d[33].push(void 0),d[33]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",d[34],d[33],c.i64.cast([0,3]))},function(e){return d[35]=new c.Map(),d[35].set("error_code",d[30]),d[35].set("error_message","Null virtual device payload"),d[35].set("stored_procedure","initializeBackupV2"),d[36]=new c.Map(),d[36].set("failure",d[35]),d[36].set("request_id",a[1]),d[37]=c.toJSON(d[36]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50033]),d[37],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[38]=a[0],a})},function(a){return d[32]=c.i64.cast([0,1])}])},function(a){return d[31]=d[32]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create virtual device payload"),d[33]="Could not create virtual device payload",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",d[33]].join("")),d[32]=c.createArray(),void 0!==void 0?d[38]=(d[32].push(void 0),d[32]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",d[33],d[32],c.i64.cast([0,3]))},function(e){return d[34]=new c.Map(),d[34].set("error_code",d[30]),d[34].set("error_message","Could not create virtual device payload"),d[34].set("stored_procedure","initializeBackupV2"),d[35]=new c.Map(),d[35].set("failure",d[34]),d[35].set("request_id",a[1]),d[36]=c.toJSON(d[35]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50033]),d[36],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[37]=a[0],a})},function(a){return d[31]=c.i64.cast([0,1])}])},function(a){return d[25]=d[31]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null epoch payload"),d[27]="Null epoch payload",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",d[27]].join("")),d[26]=c.createArray(),void 0!==void 0?d[32]=(d[26].push(void 0),d[26]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",d[27],d[26],c.i64.cast([0,3]))},function(e){return d[28]=new c.Map(),d[28].set("error_code",d[23]),d[28].set("error_message","Null epoch payload"),d[28].set("stored_procedure","initializeBackupV2"),d[29]=new c.Map(),d[29].set("failure",d[28]),d[29].set("request_id",a[1]),d[30]=c.toJSON(d[29]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50033]),d[30],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[31]=a[0],a})},function(a){return d[25]=c.i64.cast([0,1])}])},function(a){return d[24]=d[25]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create epoch payload"),d[26]="Could not create epoch payload",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",d[26]].join("")),d[25]=c.createArray(),void 0!==void 0?d[31]=(d[25].push(void 0),d[25]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",d[26],d[25],c.i64.cast([0,3]))},function(e){return d[27]=new c.Map(),d[27].set("error_code",d[23]),d[27].set("error_message","Could not create epoch payload"),d[27].set("stored_procedure","initializeBackupV2"),d[28]=new c.Map(),d[28].set("failure",d[27]),d[28].set("request_id",a[1]),d[29]=c.toJSON(d[28]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50033]),d[29],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[30]=a[0],a})},function(a){return d[24]=c.i64.cast([0,1])}])},function(a){return d[15]=d[24]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Null device payload"),d[17]="Null device payload",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",d[17]].join("")),d[16]=c.createArray(),void 0!==void 0?d[22]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",d[17],d[16],c.i64.cast([0,3]))},function(e){return d[18]=new c.Map(),d[18].set("error_code",d[7]),d[18].set("error_message","Null device payload"),d[18].set("stored_procedure","initializeBackupV2"),d[19]=new c.Map(),d[19].set("failure",d[18]),d[19].set("request_id",a[1]),d[20]=c.toJSON(d[19]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50033]),d[20],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[21]=a[0],a})},function(a){return d[15]=c.i64.cast([0,1])}])},function(a){return d[8]=d[15]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] Could not create device payload"),d[16]="Could not create device payload",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeBackupV2StoredProcedure] ","",d[16]].join("")),d[15]=c.createArray(),void 0!==void 0?d[21]=(d[15].push(void 0),d[15]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeBackupV2StoredProcedure",d[16],d[15],c.i64.cast([0,3]))},function(e){return d[17]=new c.Map(),d[17].set("error_code",d[7]),d[17].set("error_message","Could not create device payload"),d[17].set("stored_procedure","initializeBackupV2"),d[18]=new c.Map(),d[18].set("failure",d[17]),d[18].set("request_id",a[1]),d[19]=c.toJSON(d[18]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),"encrypted_backups_setup",c.i64.cast([0,50033]),d[19],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[8]=c.i64.cast([0,1])}])},function(a){return d[9]=c.i64.of_float(Date.now()),d[10]=c.i64.random(),d[12]="Finishing execution. Execution time: ",d[13]=c.i64.to_string(c.i64.sub(d[9],d[0])),d[14]=" ms",d[11]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][initializeBackupV2] ",d[11],d[12],d[11],d[13],d[11],d[14]].join("")),c.i64.eq(c.i64.mod_(d[10],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[15]=",",d[16]=c.createArray(),void 0!==void 0?d[17]=(d[16].push(void 0),d[16]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"initializeBackupV2",[d[12],d[15],d[13],d[15],d[14]].join(""),d[16],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=d[8]}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsInitializeBackupV2StoredProcedure";a.__tables__=["secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSInitializeBackupV2StoredProcedure",["LSInitializeBackupV2","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){a=a.storedProcedure(c("LSInitializeBackupV2"),e.deviceRegistrationId,e.requestId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWEncryptedBackupsInitializeBackup",["LSFactory","LSInitializeBackupV2StoredProcedure"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d){return a.runInTransaction(function(a){return c("LSInitializeBackupV2StoredProcedure")(c("LSFactory")(a),{deviceRegistrationId:b,requestId:(a=d)!=null?a:""})},"readwrite",void 0,void 0,f.id+":25")}g.initializeBackupStoredProcedure=a}),98);
__d("EBInitializeBackup",["EBAPIQPLPoints","EBMainThreadEBDBApiDeferred","EBSMAPI","I64","LSAuthorityLevel","LSDatabaseSingleton","LSEncryptedBackupsOpStatus","LSIntEnum","MAWTraceUtils","MWEncryptedBackupsDeviceRegistrationId","MWEncryptedBackupsInitializeBackup","QPLUserFlow","Random","ReQL","WAResultOrError","justknobx","qpl"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;async function a(a){var b,e=await (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton,f=(b=a.traceId)!=null?b:d("MAWTraceUtils").createTraceId(),g=(b=a.instanceKey)!=null?b:d("Random").uint32(),k=c("qpl")._(521478750,"2850");c("QPLUserFlow").start(k,{annotations:{int:{instanceKey:g}},instanceKey:g,timeoutInMs:c("justknobx")._("4211")});d("EBAPIQPLPoints").ebAPIAddQPLPoint(!1,k,d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_START,void 0,g);d("EBAPIQPLPoints").ebAPIAddQPLPoint(!1,k,d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_START,void 0,g);return new Promise(async function(a,b){b=d("MWEncryptedBackupsDeviceRegistrationId").getDeviceRegistrationId();b===""&&a(d("WAResultOrError").makeError("device_registration_id_null"));b=await d("MWEncryptedBackupsInitializeBackup").initializeBackupStoredProcedure(e,b,f);b=b[0];(i||(i=d("I64"))).equal(b,(j||(j=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").FAILURE))&&(d("EBAPIQPLPoints").ebAPIAddQPLPoint(!1,k,d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_FAIL,void 0,g),a(d("WAResultOrError").makeError("sproc_failure")));d("EBAPIQPLPoints").ebAPIAddQPLPoint(!1,k,d("EBAPIQPLPoints").EBBackupInitQPLPoints.INITIALIZE_BACKUP_SPROC_END,void 0,g);var h=e.tables.secure_encrypted_backups_client_state.subscribe(async function(b,f){if(f.operation==="delete")return;b=await d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_client_state));if(b!=null){f=b[0];b=f.authorityLevel;f=f.backupId;if((i||(i=d("I64"))).equal(b,(j||(j=d("LSIntEnum"))).ofNumber(c("LSAuthorityLevel").AUTHORITATIVE))){(b=d("EBAPIQPLPoints")).ebAPIAddQPLPoint(!1,k,b.EBBackupInitQPLPoints.INITIALIZE_BACKUP_END,void 0,g);h();b.ebAPIAddQPLPoint(!1,k,b.EBBackupInitQPLPoints.FETCH_BACKUP_IDS_START,void 0,g);c("EBSMAPI").fetchBackupIds(e).finally(function(){d("EBAPIQPLPoints").ebAPIAddQPLPoint(!1,k,d("EBAPIQPLPoints").EBBackupInitQPLPoints.FETCH_BACKUP_IDS_END,void 0,g),d("EBAPIQPLPoints").ebAPIEndSuccess(!1,k,g),void d("EBMainThreadEBDBApiDeferred").addNewDevice()});a(d("WAResultOrError").makeResult(f))}d("EBAPIQPLPoints").ebAPIAddQPLPoint(!1,k,d("EBAPIQPLPoints").EBBackupInitQPLPoints.OPTIMISTIC_CLIENT_STATE,void 0,g);return}d("EBAPIQPLPoints").ebAPIEndFailure(!1,k,"empty_client_state",g);h();return a(d("WAResultOrError").makeError("empty_client_state"))})})}g.initializeBackup=a}),98);
__d("EBMessageRangeQueryForThreadsWithPersistenceQuery_facebookRelayOperation",[],(function(a,b,c,d,e,f){e.exports="29234169046230621"}),null);
__d("EBMessageRangeQueryForThreadsWithPersistenceQuery.graphql",["EBMessageRangeQueryForThreadsWithPersistenceQuery_facebookRelayOperation"],(function(a,b,c,d,e,f){"use strict";a=function(){var a={defaultValue:null,kind:"LocalArgument",name:"app_id"},c={defaultValue:null,kind:"LocalArgument",name:"restore_payload_strings"},d={defaultValue:null,kind:"LocalArgument",name:"restore_type"},e=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_strings",variableName:"restore_payload_strings"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],f={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},j={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},k={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},l=[g,h];return{fragment:{argumentDefinitions:[a,c,d],kind:"Fragment",metadata:null,name:"EBMessageRangeQueryForThreadsWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_from_selected_threads",plural:!0,selections:[{args:null,kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[c,d,a],kind:"Operation",name:"EBMessageRangeQueryForThreadsWithPersistenceQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:e,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_from_selected_threads",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},f,g,h,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[i,f,g,h,j,k],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[i,f,g,h,j,k,{alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:l,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null}],storageKey:null}],storageKey:null}]},params:{id:b("EBMessageRangeQueryForThreadsWithPersistenceQuery_facebookRelayOperation"),metadata:{},name:"EBMessageRangeQueryForThreadsWithPersistenceQuery",operationKind:"query",text:null}}}();e.exports=a}),null);
__d("EBMessageRangeQueryForThreadsWithPersistence",["Base64Utils","EBAPIQPLPoints","EBAPIWorkerCheck","EBMessageRangeQueryForThreadsWithPersistenceQuery.graphql","I64","LSDecryptMessageProtobufsStoredProcedure","LSDecryptMessagesStoredProcedure","LSDeleteAndReenrollDeviceStateStoredProcedure","LSEncryptedBackupsMessagesRangeQueryDirection","LSFactory","LSIntEnum","LSMEBDeviceReenrollmentReason","LSMEBTaskCreationSource","LSShape","LSVec","MAWCurrentUser","MAWJobDefinitions","QPLUserFlow","WAGetSafeQPLError","WAHashStringToNumber","WAJids","WAResultOrError","createMainThreadQuery","handleRestoreMessagesGraphQLResponse","justknobx","promiseDone","qpl","requireDeferred","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=c("requireDeferred")("CometRelayEnvironment").__setRef("EBMessageRangeQueryForThreadsWithPersistence"),l=c("requireDeferred")("LSEBUnifiedRestoreUtils").__setRef("EBMessageRangeQueryForThreadsWithPersistence"),m=h!==void 0?h:h=b("EBMessageRangeQueryForThreadsWithPersistenceQuery.graphql");function n(){return k.load().then(function(a){var b=function(b,c){var e=d("createMainThreadQuery").getWorkerLikeRelayEnvironment(a);return d("createMainThreadQuery").createMainThreadQuery(b,c,e)};return b})}async function a(a){var b=a.instanceKey,e=a.restoreType,g=a.source,h=a.storage,k=a.threads,l=d("WAHashStringToNumber").hashStringToNumber((a=b)!=null?a:c("uuidv4")()),p=c("qpl")._(521473850,"2910");try{var q;c("QPLUserFlow").start(p,{annotations:{int:{source:(a=g)!=null?a:c("LSMEBTaskCreationSource").UNKNOWN}},instanceKey:l,timeoutInMs:c("justknobx")._("2950")});if(d("EBAPIWorkerCheck").runningInWorker()){c("QPLUserFlow").endFailure(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.UNSUPPORTED_CONTEXT,{instanceKey:l});return d("WAResultOrError").makeError("unsupported-context")}if(k.length===0){c("QPLUserFlow").endFailure(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_PARAMETERS,{instanceKey:l});return d("WAResultOrError").makeError("invalid-parameters")}a=await d("handleRestoreMessagesGraphQLResponse").getClientState(h);c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CLIENT_STATE_RETRIEVED,{data:{string:{device_id:(i||(i=d("I64"))).to_string((q=a==null?void 0:a.device_id)!=null?q:(i||(i=d("I64"))).zero)}},instanceKey:l});if(a==null){c("QPLUserFlow").endFailure(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}},instanceKey:l});return d("WAResultOrError").makeError("no-client-state")}var r=a.backupId,s=a.device_id,t=a.locally_available_epochs,u=a.mailboxRootKey,v=a.ocmfClientStateBlob;if(r==null||s==null||u==null||v==null){c("QPLUserFlow").endFailure(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{annotations:{bool:{hasBackupId:r!=null,hasDeviceId:s!=null,hasMailboxRootKey:u!=null,hasOcmfClientStateBlob:v!=null},string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}},instanceKey:l});return d("WAResultOrError").makeError("invalid-client-state")}a=""+((q=d("MAWCurrentUser").getAppID())!=null?q:0);q=k.map(function(a){var b=a.direction,e=a.from;e=e[0];a=a.chatJid;b=b==="before"?c("LSEncryptedBackupsMessagesRangeQueryDirection").BEFORE:c("LSEncryptedBackupsMessagesRangeQueryDirection").AFTER;a=d("WAJids").threadIdForChatJid(a);return JSON.stringify({restore_context:{act_thread_id:d("MAWJobDefinitions").toThreadJidPrimaryId(a),site:"www",tam_thread_subtype:0},success:babelHelpers.extends({device_context:{device_id:(i||(i=d("I64"))).to_string(s),locally_available_epochs:t,raw_tokens:{mailbox_root_key:d("Base64Utils").fromArrayBuffer(u),ocmf_client_state_blob:d("Base64Utils").fromArrayBuffer(v)}},direction:b,server_thread_key:a},e!=null?{reference_timestamp:e}:{})})});a={app_id:a,restore_payload_strings:q,restore_type:e==="initial"?"INITIAL_RESTORE":"RANGE_QUERY_RESTORE"};c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_START,{instanceKey:l});q=await n();c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_END,{instanceKey:l});c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START,{instanceKey:l});e=await q(m,a);c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END,{instanceKey:l});q=e==null?void 0:(q=e.viewer)==null?void 0:(a=q.encrypted_backup)==null?void 0:(e=a.mailbox)==null?void 0:e.messages_from_selected_threads;if(q==null){c("QPLUserFlow").endFailure(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{annotations:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}},instanceKey:l});return d("WAResultOrError").makeError("invalid-graphql-response")}var w=!1,x=!1;a=await Promise.all(q.map(async function(a,e){try{a=a;if(a==null)return d("WAResultOrError").makeError("invalid-graphql-response");if(w===!0)return d("WAResultOrError").makeError("server-side-exception");var m=a.backup_id,n=a.encrypted_messages,q=a.epoch_derivation_set,t=a.exception_string,u=a.message_range_info,v=a.should_delete_mailbox;a=a.thread_not_found;if(t!=null){if(a!=null&&a){c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.THREAD_NOT_FOUND_ON_SERVER,{data:{string:{exception:t}},instanceKey:l});c("QPLUserFlow").endSuccess(p,{instanceKey:l});return d("WAResultOrError").makeError("thread-not-found-on-server")}if(v===!0){w===!1&&(await h.runInTransaction(function(a){return c("LSDeleteAndReenrollDeviceStateStoredProcedure")(c("LSFactory")(a),{reenrollmentReason:(j||(j=d("LSIntEnum"))).ofNumber(c("LSMEBDeviceReenrollmentReason").RESTORE_FAILED_WITH_NO_DEVICE_FOUND),targetDeviceId:s})},"readwrite",void 0,void 0,f.id+":430"),w=!0,c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DELETE_MAILBOX,{instanceKey:l}));c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{data:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:t}},instanceKey:l});return d("WAResultOrError").makeError("server-side-exception")}}x===!1&&(c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START,{instanceKey:l}),c("QPLUserFlow").addAnnotations(p,{bool:{hasEpochs:q!=null&&q.epoch_edges.length>0}},{instanceKey:l}),await d("handleRestoreMessagesGraphQLResponse").deriveAndStoreEpochs(q,h,s,b),c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END,{instanceKey:l}),x=!0);a=u||{};v=a.has_more_after;t=a.has_more_before;q=a.next_message_timestamp_ms_after;u=a.next_message_timestamp_ms_before;if(t==null||v==null||q==null||u==null){c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO,{data:{string:{error_description:d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.MISSING_RANGE_INFO}},instanceKey:l});return d("WAResultOrError").makeError("missing-message-range-info")}a=k[e];e=a.chatJid;a=a.from;a=a[0];var y=d("WAJids").threadIdForChatJid(e);m==null&&c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL,{instanceKey:l});c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_START,{instanceKey:l});n=d("handleRestoreMessagesGraphQLResponse").processMessageArray(n,m!=null?m:(i||(i=d("I64"))).to_string(r));m=n.encryptedLSEchoMessages;n=n.encryptedMessagesWithProtobufs;n=await o(h,y,e,(y=n)!=null?y:[],(e=m)!=null?e:[],{has_more_after:v,has_more_before:t,next_message_timestamp_ms_after:q,next_message_timestamp_ms_before:u},a,g,l,p);if(n.success===!0){c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_END,{instanceKey:l});return d("WAResultOrError").makeResult()}else{c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_FAILURE,{instanceKey:l});c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROCESS_AND_DECRYPT_MESSAGES_END,{instanceKey:l});return d("WAResultOrError").makeError("decryption-error")}}catch(a){return d("WAResultOrError").makeError("runtime-error")}}));a.every(function(a){a=a.success;return a===!1})?c("QPLUserFlow").endFailure(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BATCH_RESTORE_AND_DECRYPT_FAILURE,{instanceKey:l}):c("QPLUserFlow").endSuccess(p,{annotations:{int:{attemptCount:q.length,errorCount:a.reduce(function(a,b){b=b.success;return b===!1?a+1:a},0)}},instanceKey:l});return d("WAResultOrError").makeResult(a)}catch(a){c("QPLUserFlow").endFailure(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{annotations:{string:{error:d("WAGetSafeQPLError").getSafeQPLErrorMessage(a)}},instanceKey:l});return d("WAResultOrError").makeError("runtime-error")}}async function o(a,b,e,g,h,k,m,n,o,p){n===void 0&&(n=c("LSMEBTaskCreationSource").UNKNOWN);try{var q=k.has_more_after,r=k.has_more_before,s=k.next_message_timestamp_ms_after,t=k.next_message_timestamp_ms_before;k=await a.runInTransaction(async function(f){var a=[],e=null;if(h.length>0){c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_START,{instanceKey:o});var i=await c("LSDecryptMessagesStoredProcedure")(c("LSFactory")(f),{actThreadId:b,encryptedMessages:c("LSVec").ofArray(h)}),j=i[0];i=i[1];j!=null&&(a=c("LSVec").toArray(j).map(function(a){return d("LSShape").toRecord(a).value}));i!=null&&c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.ECHO_DECRYPTION_FAILURE,{instanceKey:o});c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_ECHO_END,{instanceKey:o})}if(g.length>0){c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_START,{instanceKey:o});j=await c("LSDecryptMessageProtobufsStoredProcedure")(c("LSFactory")(f),{actThreadId:b,encryptedMessagesWithProtobufs:c("LSVec").ofArray(g)});i=j[0];f=j[1];i!=null&&(e=i);f!=null&&c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.PROTOBUF_DECRYPTION_FAILURE,{instanceKey:o});c("QPLUserFlow").addPoint(p,d("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DECRYPT_MESSAGES_PROTOBUF_END,{instanceKey:o})}return{decryptedEchoMsgs:a,decryptedProtobufMsgs:e}},"readwrite",void 0,void 0,f.id+":700");var u=k.decryptedEchoMsgs,v=k.decryptedProtobufMsgs;c("promiseDone")(l.load().then(function(a){return a.echoProtobufConsolidatedRestoreHelper(b,(a=v)!=null?a:c("LSVec").ofArray([]),r,(i||(i=d("I64"))).of_string(t),q,i.of_string(s),!1,void 0,""+m,void 0,c("LSVec").ofArray(u),(j||(j=d("LSIntEnum"))).ofNumber(n),e,!0)}));return d("WAResultOrError").makeResult()}catch(a){return d("WAResultOrError").makeError("runtime-error")}}g.messageRangeQueryForThreadsWithPersistence=a}),98);
__d("EBSetRestoreStatusForInitialRestore",["I64","LSEncryptedBackupsClientRestoreState","LSIntEnum","ReQL","WAJids","performanceAbsoluteNow"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;async function a(a,b){var e=await d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(b.tables.encrypted_backups_client_restore_status).map(function(a){a=a.threadId;return a}));return b.runInTransaction(async function(b){var f=[],g=[];e.forEach(function(a){f.push(b.encrypted_backups_client_restore_status.delete(a))});await Promise.all(f);a.forEach(function(a){g.push(b.encrypted_backups_client_restore_status.put({lastUpdated:(j||(j=d("I64"))).of_float((h||(h=c("performanceAbsoluteNow")))()),restoreStatus:(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsClientRestoreState").RESTORE_IN_PROGRESS),threadId:d("WAJids").threadIdForChatJid(a)}))});await Promise.all(g)},"readwrite",void 0,void 0,f.id+":37")}async function b(a){var b=await d("ReQL").toArrayAsync(d("ReQL").fromTableAscending(a.tables.encrypted_backups_client_restore_status).map(function(a){a=a.threadId;return a}));return a.runInTransaction(async function(a){var c=[];b.forEach(function(b){c.push(a.encrypted_backups_client_restore_status.delete(b))});await Promise.all(c)},"readwrite",void 0,void 0,f.id+":75")}g.setRestoreStatusForInitialRestore=a;g.resetClientRestoreStatus=b}),98);
__d("LSCreateDataTrace",[],(function(a,b,c,d,e,f){function a(){var a=arguments,b=a[a.length-1],c=[],d=[];return b.sequence([function(d){return c[0]=b.i64.of_float(Date.now()),b.db.table(153).add({traceId:a[0],initTimestampMs:c[0],traceType:a[4],shouldFlush:!1,contextOne:a[1],contextTwo:a[2],contextThree:a[3]})},function(a){return b.resolve(d)}])}a.__sproc_name__="LSDataTraceCreateDataTraceStoredProcedure";a.__tables__=["data_trace_meta"];e.exports=a}),null);
__d("LSCreateDataTraceID.nop",["LSRequestId","LSResult","Promise"],(function(a,b,c,d,e,f,g){"use strict";var h;a=function(a,d){return(h||(h=b("Promise"))).resolve(c("LSResult")(c("LSRequestId").generate()))};a.__nop_name__="LSCreateDataTraceID";g["default"]=a}),98);
__d("LSInitializeRestore",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSCreateDataTrace","LSCreateDataTraceID.nop","LSGetLatestThreadIds.nop","LSIsEncryptionVersionSecure","LSIsMobileClient","LSIssueMessageRangeQueryTask","LSIssueNewTask","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(a){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][LSEncryptedBackupsInitializeRestoreStoredProcedure] Beginning execution."),d[1]=c.i64.cast([0,1e3]),c.nativeOperation(b("LSGetLatestThreadIds.nop"),"AdvancedCrypto",d[1],!0).then(function(a){return a=a,d[2]=a[0],d[3]=a[1],a})},function(a){return c.forEach(c.db.table(231).fetch(),function(a){return a["delete"]()})},function(e){return d[3]?d[2]!==void 0?(d[10]=c.i64.of_int32(d[2].length),c.i64.gt(d[10],c.i64.cast([0,0]))?(d[11]=c.i64.cast([0,0]),d[12]=c.i64.of_int32(d[2].length),c.i64.gt(d[12],c.i64.cast([0,0]))?c.loopAsync(d[12],function(e){return d[13]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[2],d[13]).then(function(a){return a=a,d[14]=a[0],d[15]=a[1],a})},function(e){return d[19]=c.i64.add(d[11],c.i64.cast([0,1])),a[0]!==void 0?c.resolve(d[16]=a[0]):c.sequence([function(a){return c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?(f=[void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,1]),void 0,void 0,void 0,void 0,void 0,void 0,void 0,c.i64.cast([0,20]),void 0],d[20]=f[0],d[21]=f[1],d[22]=f[2],d[23]=f[3],d[24]=f[4],d[25]=f[5],d[26]=f[6],d[27]=f[7],d[28]=f[8],d[29]=f[9],d[30]=f[10],d[31]=f[11],d[32]=f[12],d[33]=f[13],d[34]=f[14],d[35]=f[15],d[36]=f[16],f):(e=a.item,c.sequence([function(a){return d[45]=e.backupTenancy,d[44]=e.encryptionVersion,d[40]=void 0,c.i64.neq(d[40],void 0)?c.resolve(d[41]=d[40]):c.sequence([function(a){return d[46]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[56]=(d[46].push(c.i64.cast([0,0])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[56]=(d[46].push(c.i64.cast([0,2])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[56]=(d[46].push(c.i64.cast([0,3])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[56]=(d[46].push(c.i64.cast([0,4])),d[46]):0,d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[56]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[56]).then(function(a){return a=a,d[57]=a[0],d[58]=a[1],a})},function(a){return d[59]=(d[51].push(d[57]),d[51])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[56]=c.createArray(),d[57]=c.i64.of_int32(d[51].length),c.i64.gt(d[57],c.i64.cast([0,0]))?c.loopAsync(d[57],function(a){return d[59]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[51],d[59]).then(function(a){return a=a,d[60]=a[0],d[61]=a[1],a})},function(a){return d[62]=(d[56].push(c.i64.to_string(d[60])),d[56])}])}):c.resolve()},function(a){return d[58]=d[56].join(","),d[53]=d[58]}])},function(a){return d[51].some(function(a){return c.i64.eq(d[44],a)})?d[54]=d[44]:d[54]=void 0,c.i64.neq(d[54],void 0)?d[55]=d[54]:d[55]=void 0,d[41]=d[55]}])},function(a){return c.i64.neq(d[41],void 0)?d[42]=d[41]:d[42]=c.i64.cast([0,0]),c.i64.neq(d[45],void 0)?d[43]=d[45]:d[43]=c.i64.cast([0,1]),a=[e.backupId,e.deviceId,e.mailboxRootKeyBlob,e.ocmfClientStateBlob,void 0,void 0,d[42],d[43],e.epochAuthPublicKeyBlob,e.epochAuthPrivateKeyBlob,e.devicePublicKeyBlob,e.devicePrivateKeyBlob,e.epochStoragePublicKeyBlob,e.epochStoragePrivateKeyBlob,e.obliviousValidationTokenBlob,e.authorityLevel,void 0],d[20]=a[0],d[21]=a[1],d[22]=a[2],d[23]=a[3],d[24]=a[4],d[25]=a[5],d[26]=a[6],d[27]=a[7],d[28]=a[8],d[29]=a[9],d[30]=a[10],d[31]=a[11],d[32]=a[12],d[33]=a[13],d[34]=a[14],d[35]=a[15],d[36]=a[16],a}]))})},function(a){return c.i64.eq(d[35],c.i64.cast([0,80]))&&c.i64.eq(d[27],c.i64.cast([0,2]))?d[38]=c.i64.or_(c.i64.cast([0,73]),c.i64.cast([0,128])):d[38]=c.i64.cast([0,73]),c.sequence([function(a){return c.nativeOperation(b("LSCreateDataTraceID.nop")).then(function(a){return a=a,d[40]=a[0],a})},function(a){return c.sequence([function(a){return d[44]="EncryptedBackups MCD Trace ID",d[45]=c.i64.to_string(d[38]),d[43]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][MEBTraceUtils] ",d[43],d[44],d[43],d[45]].join("")),c.resolve()},function(a){return c.storedProcedure(b("LSCreateDataTrace"),d[40],void 0,void 0,"restore_messages",d[38])}])},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[41]=a[0],a})},function(a){return d[41]?d[42]=!0:d[42]=!1,d[42]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[44]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[44]].join("")),d[43]=c.createArray(),void 0!==void 0?d[45]=(d[43].push(void 0),d[43]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[44],d[43],c.i64.cast([0,3]))):c.resolve()},function(a){return d[39]=d[40]}])},function(a){return d[16]=d[39]}])},function(a){return c.sequence([function(a){return d[16]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[16],c.i64.cast([0,2506]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!0:d[21]=!1,d[21]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[23]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[23]].join("")),d[22]=c.createArray(),void 0!==void 0?d[24]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[23],d[22],c.i64.cast([0,3]))):c.resolve()}])},function(a){return d[17]=c.i64.of_float(Date.now()),c.db.table(231).add({threadId:d[14],lastUpdated:d[17],restoreStatus:c.i64.cast([0,1])})},function(a){return c.sequence([function(a){return d[16]!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),d[16],c.i64.cast([0,3602]),c.i64.cast([0,2]),void 0,void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!0:d[21]=!1,d[21]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[23]="LSDataTraceMciTraceLog native op not supported",function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][MEBTraceUtils] ","",d[23]].join("")),d[22]=c.createArray(),void 0!==void 0?d[24]=(d[22].push(void 0),d[22]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils",d[23],d[22],c.i64.cast([0,3]))):c.resolve()}])},function(a){return c.i64.gt(d[19],c.i64.cast([0,20]))?d[18]="encrypted_backups_restore":d[18]=["encrypted_backups_restore",":",d[14]].join(""),c.storedProcedure(b("LSIssueMessageRangeQueryTask"),d[14],c.i64.cast([0,20]),void 0,!1,d[16],c.i64.cast([0,0]),c.i64.cast([-1,4294967295]),!1)},function(a){return d[11]=d[19]}])}):c.resolve()):(d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,113])),d[11].set("error_message",void 0==null?"":void 0),d[11].set("stored_procedure","initializeRestore"),d[12]=new c.Map(),d[12].set("act_thread_id",""),d[12].set("source",c.i64.cast([-1,4294967295])),d[12].set("restore_operation_type",c.i64.cast([0,3])),d[12].set("request_id",void 0),d[12].set("device_id",void 0),d[13]=new c.Map(),d[13].set("restore_context",d[12]),d[13].set("failure",d[11]),d[14]=d[13].get("queue_name"),d[14]!==void 0?d[15]=d[14]:(d[17]=d[13].get("restore_context"),d[18]=d[17].get("act_thread_id"),d[15]=["encrypted_backups_restore",":",d[18]].join("")),d[16]=c.toJSON(d[13]),c.storedProcedure(b("LSIssueNewTask"),d[15],c.i64.cast([0,50030]),d[16],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0])))):(d[10]=new c.Map(),d[10].set("error_code",c.i64.cast([0,107])),d[10].set("error_message",void 0==null?"":void 0),d[10].set("stored_procedure","initializeRestore"),d[11]=new c.Map(),d[11].set("act_thread_id",""),d[11].set("source",c.i64.cast([-1,4294967295])),d[11].set("restore_operation_type",c.i64.cast([0,3])),d[11].set("request_id",void 0),d[11].set("device_id",void 0),d[12]=new c.Map(),d[12].set("restore_context",d[11]),d[12].set("failure",d[10]),d[13]=d[12].get("queue_name"),d[13]!==void 0?d[14]=d[13]:(d[16]=d[12].get("restore_context"),d[17]=d[16].get("act_thread_id"),d[14]=["encrypted_backups_restore",":",d[17]].join("")),d[15]=c.toJSON(d[12]),c.storedProcedure(b("LSIssueNewTask"),d[14],c.i64.cast([0,50030]),d[15],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]))):(d[10]=new c.Map(),d[10].set("error_code",c.i64.cast([0,107])),d[10].set("error_message",void 0==null?"":void 0),d[10].set("stored_procedure","initializeRestore"),d[11]=new c.Map(),d[11].set("act_thread_id",""),d[11].set("source",c.i64.cast([-1,4294967295])),d[11].set("restore_operation_type",c.i64.cast([0,3])),d[11].set("request_id",void 0),d[11].set("device_id",void 0),d[12]=new c.Map(),d[12].set("restore_context",d[11]),d[12].set("failure",d[10]),d[13]=d[12].get("queue_name"),d[13]!==void 0?d[14]=d[13]:(d[16]=d[12].get("restore_context"),d[17]=d[16].get("act_thread_id"),d[14]=["encrypted_backups_restore",":",d[17]].join("")),d[15]=c.toJSON(d[12]),c.storedProcedure(b("LSIssueNewTask"),d[14],c.i64.cast([0,50030]),d[15],void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0]),void 0,void 0,c.i64.cast([0,0]),c.i64.cast([0,0])))},function(a){return d[4]=c.i64.of_float(Date.now()),d[5]=c.i64.random(),d[7]="Finishing execution. Execution time: ",d[8]=c.i64.to_string(c.i64.sub(d[4],d[0])),d[9]=" ms",d[6]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][LSEncryptedBackupsInitializeRestoreStoredProcedure] ",d[6],d[7],d[6],d[8],d[6],d[9]].join("")),c.i64.eq(c.i64.mod_(d[5],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[10]=",",d[11]=c.createArray(),void 0!==void 0?d[12]=(d[11].push(void 0),d[11]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsInitializeRestoreStoredProcedure",[d[7],d[10],d[8],d[10],d[9]].join(""),d[11],c.i64.cast([0,4]))):c.resolve()},function(a){return e[0]=c.i64.cast([0,0])}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsInitializeRestoreStoredProcedure";a.__tables__=["encrypted_backups_client_restore_status","secure_encrypted_backups_client_state"];e.exports=a}),null);
__d("LSInitializeRestoreStoredProcedure",["LSInitializeRestore","LSSynchronousPromise","Promise","cr:8709"],(function(a,b,c,d,e,f,g){var h;function a(a,e){e===void 0&&(e={});a=a.storedProcedure(c("LSInitializeRestore"),e.traceId);return(h||(h=b("Promise"))).resolve(d("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(a))}g["default"]=a}),98);
__d("MWEncryptedBackupsInitializeRestore",["EBGetLatestChatJids","EBMessageRangeQueryForThreadsWithPersistence","EBSetRestoreStatusForInitialRestore","ExecutionEnvironment","I64","LSEncryptedBackupsOpStatus","LSFactory","LSInitializeRestoreStoredProcedure","LSIntEnum","LSMEBTaskCreationSource","LSRequestId","MAWEBRestoreTrackingUtils","MpsTypes","getErrorSafe","gkx"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;async function k(a,b){try{d("MAWEBRestoreTrackingUtils").markEBRestoreInitial({querySource:"GQL_MAIN_THREAD",traceId:b});var e=await d("EBGetLatestChatJids").getLatestChatJids(a);if(e.success===!1)return;var f=e.value.map(function(a){return{chatJid:a,direction:"before",from:[d("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),void 0]}});await d("EBSetRestoreStatusForInitialRestore").setRestoreStatusForInitialRestore(e.value,a);e=await d("EBMessageRangeQueryForThreadsWithPersistence").messageRangeQueryForThreadsWithPersistence({instanceKey:b,restoreType:"initial",source:c("LSMEBTaskCreationSource").EB_ADD_DEVICE,storage:a,threads:f});e.success===!1&&(d("MAWEBRestoreTrackingUtils").markEBRestoreFail(b,(j||(j=c("ExecutionEnvironment"))).isInWorker,"initialize_restore_failed: "+e.error),await d("EBSetRestoreStatusForInitialRestore").resetClientRestoreStatus(a));e.success===!0&&e.value.some(function(a){a=a.success;return a===!1})&&await d("EBSetRestoreStatusForInitialRestore").resetClientRestoreStatus(a)}catch(e){d("MAWEBRestoreTrackingUtils").markEBRestoreFail(b,(j||(j=c("ExecutionEnvironment"))).isInWorker,"initialize_restore_failed: "+c("getErrorSafe")(e).message);await d("EBSetRestoreStatusForInitialRestore").resetClientRestoreStatus(a);throw e}}function l(a,b){d("MAWEBRestoreTrackingUtils").markEBRestoreInitial({querySource:"LS",traceId:b});return a.runInTransaction(function(a){return c("LSInitializeRestoreStoredProcedure")(c("LSFactory")(a),{traceId:b})},"readwrite",void 0,void 0,f.id+":117").then(function(a){a=a[0];(h||(h=d("I64"))).equal(a,(i||(i=d("LSIntEnum"))).ofNumber(c("LSEncryptedBackupsOpStatus").SUCCESS))||d("MAWEBRestoreTrackingUtils").markEBRestoreFail(b,(j||(j=c("ExecutionEnvironment"))).isInWorker,"initialize_restore_failed")}).catch(function(a){d("MAWEBRestoreTrackingUtils").markEBRestoreFail(b,(j||(j=c("ExecutionEnvironment"))).isInWorker,"initialize_restore_failed: "+a.message);throw a})}function a(a){var b=c("LSRequestId").generate();if(c("gkx")("12983"))return k(a,b);else return l(a,b)}g.initializeRestore=a}),98);
__d("WASmaxInPreKeysRotateSignedResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrors","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInPreKeysRequestErrors").parseRequestErrors(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRequestErrors:b.value}))}g.parseRotateSignedResponseRequestError=a}),98);
__d("WASmaxInPreKeysRotateSignedResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInPreKeysServerErrors").parseServerErrors(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorServerErrors:b.value}))}g.parseRotateSignedResponseServerError=a}),98);
__d("WASmaxInPreKeysRotateSignedResponseSuccess",["WASmaxInPreKeysIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(a,b);return!c.success?c:c}g.parseRotateSignedResponseSuccess=a}),98);
__d("WASmaxInPreKeysRotateSignedResponseValidationError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysIdentityKeyMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;var e=d("WASmaxParseUtils").attrString(c.value,"text");if(!e.success)return e;var f=d("WASmaxParseUtils").attrIntRange(c.value,"code",400,499);if(!f.success)return f;c=d("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(c.value);if(!c.success)return c;a=d("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorText:e.value,errorCode:f.value,errorIdentityKeyMixin:c.value},a.value))}g.parseRotateSignedResponseValidationError=a}),98);
__d("WASmaxOutPreKeysRotateSignedRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin","WASmaxOutPreKeysSignedPreKeyMixin"],(function(a,b,c,d,e,f,g){function a(a){a=a.signedPreKeyMixinArgs;a=d("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(d("WASmaxJsx").smax("iq",{type:"set"},d("WASmaxOutPreKeysSignedPreKeyMixin").mergeSignedPreKeyMixin(d("WASmaxJsx").smax("rotate",null),a)));return a}g.makeRotateSignedRequest=a}),98);
__d("WASmaxPreKeysRotateSignedRPC",["WAComms","WASmaxInPreKeysRotateSignedResponseRequestError","WASmaxInPreKeysRotateSignedResponseServerError","WASmaxInPreKeysRotateSignedResponseSuccess","WASmaxInPreKeysRotateSignedResponseValidationError","WASmaxOutPreKeysRotateSignedRequest","WASmaxParsingFailure","WASmaxRpcUtils"],(function(a,b,c,d,e,f,g){async function a(a,b){a=d("WASmaxOutPreKeysRotateSignedRequest").makeRotateSignedRequest(a);b=await d("WAComms").sendSmaxStanza(a,b);var c=d("WASmaxInPreKeysRotateSignedResponseSuccess").parseRotateSignedResponseSuccess(b,a);if(c.success)return{name:"RotateSignedResponseSuccess",value:c.value};var e=d("WASmaxInPreKeysRotateSignedResponseValidationError").parseRotateSignedResponseValidationError(b,a);if(e.success)return{name:"RotateSignedResponseValidationError",value:e.value};var f=d("WASmaxInPreKeysRotateSignedResponseRequestError").parseRotateSignedResponseRequestError(b,a);if(f.success)return{name:"RotateSignedResponseRequestError",value:f.value};b=d("WASmaxInPreKeysRotateSignedResponseServerError").parseRotateSignedResponseServerError(b,a);if(b.success)return{name:"RotateSignedResponseServerError",value:b.value};throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("RotateSigned",{Success:c,ValidationError:e,RequestError:f,ServerError:b}))}g.sendRotateSignedRPC=a}),98);
__d("WARotateSignedPreKeyProtocol",["WACryptoManager","WAErrorMessage","WAGlobals","WAHandleFailureUtils","WAMakeSignedPreKeyMixin","WAResultOrError","WASmaxPreKeysRotateSignedRPC","WATagsLogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["successfully rotated new skey"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["ServerError: "," ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["RequestError: "," ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["ValidationError: "," ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["generated skey. Start rotating skey..."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["start generating skey..."]);m=function(){return a};return a}var n=d("WATagsLogger").TAGS(["rotateSignedPreKeyProtocol"]);async function a(){n.LOG(m());try{var a=await d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return d("WACryptoManager").generateSignedPreKey(a)},{operationType:"generate_signed_prekey",flush:!0,afterInit:!0});n.LOG(l());a=await d("WASmaxPreKeysRotateSignedRPC").sendRotateSignedRPC({signedPreKeyMixinArgs:d("WAMakeSignedPreKeyMixin").makeSignedPreKeyMixin(a)});switch(a.name){case"RotateSignedResponseValidationError":var b=a.value,c=b.errorCode,e=b.errorText;b=b.errorIdentityKeyMixin;n.ERROR(k(),c,e);return d("WAResultOrError").makeError({type:"validation-error",identity:b.elementValue});case"RotateSignedResponseRequestError":c=a.value.errorRequestErrors.value.code;e=a.value.errorRequestErrors.name;n.ERROR(j(),c,e);return d("WAResultOrError").makeError({type:"request-error"});case"RotateSignedResponseServerError":b=a.value.errorServerErrors.value.code;c=a.value.errorServerErrors.name;n.ERROR(i(),b,c);return d("WAResultOrError").makeError({type:"server-error"});default:a.name;n.LOG(h());return d("WAResultOrError").makeResult()}}catch(a){e=d("WAErrorMessage").maybeGetMessageFromError(a);if(e.includes("No lastSignedPrekeyId and registration")){await d("WAHandleFailureUtils").reregisterPhone();return d("WAResultOrError").makeError({type:"no-prekey-reregistered"})}throw a}}g.rotateSignedPreKeyProtocol=a}),98);
__d("WARotateSignedPreKey",["WAGenerateAndUploadPreKeys","WALoggerTag","WARotateSignedPreKeyProtocol","WATagsLogger","err"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["rotateSignedPreKey failed."]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Signed prekey failed server validation. need to upload all keys."]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS([c("WALoggerTag").SignedPrekeyRotation,c("WALoggerTag").SignedPrekey]);async function a(a){a=await d("WARotateSignedPreKeyProtocol").rotateSignedPreKeyProtocol();if(a.success||a.error.type==="no-prekey-reregistered")return;if(a.error.type==="validation-error"){k.ERROR(j());d("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys(null,{reason:"signed prekey failed server validation"}).catch(function(a){k.ERROR(i(),a)});return Promise.resolve()}k.ERROR(h());throw c("err")("rotateSignedPreKey RPC failed: "+a.error.type)}g.rotateSignedPreKey=a}),98);